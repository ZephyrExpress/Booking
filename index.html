<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zephyr Express Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="icon" href="https://raw.githubusercontent.com/zephyrexpress/Booking/main/Icon.png">
  <style>
    :root { --primary-color: #0f172a; --accent-color: #3b82f6; --zephyr-green: #10b981; --bg-color: #f1f5f9; --card-radius: 12px; }
    body { background-color: var(--bg-color); font-family: 'Segoe UI', system-ui, sans-serif; color: #334155; padding-bottom: 80px; }
    .login-wrapper { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%); }
    .login-card { width: 100%; max-width: 400px; padding: 3rem 2rem; background: white; border-radius: 24px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); }
    .main-container { max-width: 1400px; margin: 0 auto; padding: 15px; display: none; }
    .navbar-custom { background: white; padding: 12px 20px; border-radius: var(--card-radius); box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 20px; position: relative; border: 1px solid #e2e8f0; }
    .logo-img { height: 42px; width: auto; object-fit: contain; }
    .navbar-center { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
    .panel-card { background: white; border-radius: var(--card-radius); border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.01); height: 100%; }
    .task-card-horizontal { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; transition: transform 0.2s; }
    .task-card-horizontal:hover { transform: translateY(-2px); box-shadow: 0 5px 15px -3px rgba(0,0,0,0.05); }
    .form-control, .form-select { border-radius: 8px; border-color: #cbd5e1; }
    .btn-zephyr-green { background-color: var(--zephyr-green); color: white; border:none; font-weight:600; }
    .split-col { height: 600px; overflow-y: auto; }
    .nav-pills .nav-link { color: #64748b; font-weight: 600; padding: 8px 20px; border-radius: 50px; position: relative; }
    .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; }
    .stat-val { font-size: 2rem; font-weight: 800; line-height: 1; }
    .spinner-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:9999; display:none; justify-content:center; align-items:center; }
    .overview-stat-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: transform 0.2s; height: 100%; }
    .text-live-red { color: #dc2626; text-shadow: 0 2px 10px rgba(220, 38, 38, 0.15); }
    .badge-notif { position: absolute; top: -5px; right: -5px; font-size: 0.7rem; }
    .ts-dropdown { z-index: 1055 !important; }
    @media(max-width: 991px) { .navbar-center { position: relative; left: auto; top: auto; transform: none; display: block; margin: 0 auto 10px auto; } .navbar-custom { flex-wrap: wrap; text-align: center; justify-content: center; } }
  </style>
</head>
<body>

<div id="spinner" class="spinner-overlay"><div class="spinner-border text-primary" role="status"></div></div>

<div id="loginSection" class="login-wrapper">
  <div class="login-card">
    <img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" alt="Logo" class="logo-img mb-4 d-block mx-auto">
    <h5 class="fw-bold mb-4 text-center text-dark">Portal Access</h5>
    <form onsubmit="event.preventDefault(); doLogin();">
      <div class="form-floating mb-3"><input type="text" class="form-control" id="uIn" required><label>Username</label></div>
      <div class="form-floating mb-4"><input type="text" class="form-control" id="pIn" required style="-webkit-text-security: disc;"><label>Password</label></div>
      <button type="submit" class="btn btn-dark w-100 py-3 rounded-pill fw-bold">LOG IN</button>
    </form>
    <div id="loginError" class="alert alert-danger mt-3 small p-2 border-0 fw-bold text-center" style="display:none;"></div>
  </div>
</div>

<div id="appSection" class="main-container">
  <div class="navbar-custom d-lg-flex justify-content-between align-items-center">
    <div class="d-none d-lg-block"><div class="bg-light px-3 py-1 rounded-pill border small fw-bold text-secondary"><i class="bi bi-person-fill"></i> <span id="userBadge">User</span></div></div>
    <div class="navbar-center"><img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" alt="Logo" class="logo-img"></div>
    <div class="text-center"><button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-circle"><i class="bi bi-power"></i></button></div>
  </div>

  <ul class="nav nav-pills justify-content-center mb-4" id="mainNav">
    <li class="nav-item" id="nav-inbound"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#inbound-tab"><i class="bi bi-box-seam me-2"></i>Inbound Entry</button></li>
    <li class="nav-item" id="nav-overview"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#overview-tab" onclick="loadOverview()"><i class="bi bi-grid-1x2 me-2"></i>Overview</button></li>
    <li class="nav-item" id="nav-taskhub"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#taskhub-tab" onclick="loadTaskHub()"><i class="bi bi-list-check me-2"></i><span id="taskHubLabel">Work Panel</span></button></li>
    <li class="nav-item" id="nav-admin" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin-tab" onclick="loadAdminPanel()"><i class="bi bi-shield-lock me-2"></i>Admin Panel <span class="badge bg-danger badge-notif rounded-circle" id="adminBadge" style="display:none">0</span></button></li>
  </ul>

  <div class="tab-content">
    <!-- INBOUND -->
    <div class="tab-pane fade" id="inbound-tab">
      <div class="row justify-content-center">
        <div class="col-xl-10">
          <div class="panel-card p-4">
            <h5 class="fw-bold mb-4 border-bottom pb-2">New Shipment Inbound</h5>
            <form id="shipForm">
              <div class="row g-3">
                <div class="col-md-4"><label class="small fw-bold">AWB *</label><input type="text" id="f_awb" class="form-control" required></div>
                <div class="col-md-4"><label class="small fw-bold">Date *</label><input type="date" id="f_date" class="form-control" required></div>
                <div class="col-md-4"><label class="small fw-bold">Type *</label><select id="f_type" class="form-select" required><option>Dox</option><option>Ndox</option></select></div>
                <div class="col-md-4"><label class="small fw-bold">Network *</label><select id="f_net" class="form-select" required></select></div>
                <div class="col-md-4"><label class="small fw-bold">Client *</label><select id="f_client" required></select></div>
                <div class="col-md-4"><label class="small fw-bold">Destination *</label><select id="f_dest" required></select></div>
                <div class="col-6"><label class="small fw-bold">Total Boxes *</label><input type="number" id="f_boxes" class="form-control" min="1" required></div>
                <div class="col-6"><label class="small fw-bold">Chargeable Wgt</label><input type="text" id="f_totalChg" class="form-control bg-light fw-bold" readonly value="0.00"></div>
              </div>
              <div class="mt-4 p-3 bg-light rounded border">
                <div class="d-flex justify-content-between align-items-center mb-2"><strong class="small text-muted">DIMENSIONS</strong><button type="button" class="btn btn-zephyr-green btn-sm rounded-pill px-3" onclick="genBoxes()">Generate Rows</button></div>
                <div class="table-responsive bg-white border rounded"><table class="table table-sm mb-0"><thead class="bg-light"><tr><th>#</th><th>Wgt (KG) *</th><th>L</th><th>B</th><th>H</th><th>Vol</th></tr></thead><tbody id="boxTable"></tbody></table></div>
              </div>
              <div class="mt-4"><label class="small fw-bold mb-2">Extra Charges</label><div id="f_extra" class="d-flex flex-wrap gap-2 p-3 border rounded bg-white w-100"></div></div>
              <div class="mt-3"><label class="small fw-bold">Extra Charges Remarks (If Applicable)</label><textarea id="f_remarks" class="form-control" rows="1"></textarea></div>
              <button type="submit" class="btn btn-primary w-100 py-3 mt-4 rounded-pill fw-bold shadow-sm">SUBMIT ENTRY</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- OVERVIEW -->
    <div class="tab-pane fade" id="overview-tab">
      <div class="row g-4 mb-4">
        <div class="col-md-4"><div class="overview-stat-card border-success border-opacity-25 bg-success bg-opacity-10"><div class="overview-label text-success">Today's Inbound (<span id="ovDate"></span>)</div><div class="stat-val text-success" id="ovInbound">0</div></div></div>
        <div class="col-md-4"><div class="overview-stat-card border-danger border-opacity-25"><div class="overview-label text-danger">Pending Automation</div><div class="stat-val text-live-red" id="ovAuto">0</div></div></div>
        <div class="col-md-4"><div class="overview-stat-card border-warning border-opacity-25"><div class="overview-label text-warning text-dark">Pending Paperwork</div><div class="stat-val text-live-red" id="ovPaper">0</div></div></div>
      </div>
      <div class="row g-4">
        <div class="col-md-6"><div class="panel-card"><div class="panel-header border-bottom-0 bg-white"><span><i class="bi bi-robot me-2 text-danger"></i>Pending for Automation</span></div><div class="split-col p-0"><div class="list-group list-group-flush" id="listAuto"></div></div></div></div>
        <div class="col-md-6"><div class="panel-card"><div class="panel-header border-bottom-0 bg-white"><span><i class="bi bi-files me-2 text-warning"></i>Pending for Paperwork & Label Pasting</span></div><div class="split-col p-0"><div class="list-group list-group-flush" id="listPaper"></div></div></div></div>
      </div>
    </div>

    <!-- TASK HUB -->
    <div class="tab-pane fade" id="taskhub-tab">
      <div id="staffTaskView" style="display:none;">
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabAssign">Assign Next Step</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabTodo">My Assignments</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tabAssign">
            <div class="alert alert-light border small text-muted"><i class="bi bi-info-circle me-2"></i>Shipments you automated. Assign them to a Paperwork Doer.</div>
            <div id="staffAssignContainer"></div>
            <div id="noAssignMsg" class="text-center py-5 text-muted" style="display:none;">No pending assignments found.</div>
          </div>
          <div class="tab-pane fade" id="tabTodo">
            <div class="alert alert-light border small text-muted"><i class="bi bi-info-circle me-2"></i>Paperwork tasks assigned to you. Mark done when complete.</div>
            <div id="staffTodoContainer"></div>
            <div id="noTodoMsg" class="text-center py-5 text-muted" style="display:none;">You have no active tasks.</div>
          </div>
        </div>
      </div>
      <div id="adminTaskView" style="display:none;">
        <div class="panel-card p-3">
          <h6 class="fw-bold mb-3">Global Task Assignment Pool (Paperwork Only)</h6>
          <div class="table-responsive"><table class="table table-hover align-middle"><thead class="bg-light"><tr><th>ID</th><th>Type</th><th>Details</th><th>Assign To</th><th>Action</th></tr></thead><tbody id="poolTable"></tbody></table></div>
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div class="tab-pane fade" id="admin-tab">
      <div class="row g-4">
        <div class="col-md-6"><div class="panel-card p-3 h-100"><h6 class="fw-bold mb-3 text-warning">Transfer Requests</h6><div id="adminReqList" class="list-group list-group-flush"></div></div></div>
        <div class="col-md-6"><div class="panel-card p-3 h-100"><h6 class="fw-bold mb-3 text-primary">Manage Users</h6><div class="input-group mb-3"><input id="nu_u" class="form-control" placeholder="User"><input id="nu_p" class="form-control" placeholder="Pass"><input id="nu_n" class="form-control" placeholder="Name"><select id="nu_r" class="form-select" style="max-width:80px"><option>Staff</option><option>Admin</option></select><button onclick="addUser()" class="btn btn-success">+</button></div><div style="max-height:200px;overflow-y:auto"><table class="table table-sm"><thead class="bg-light"><tr><th>User</th><th>Pass</th><th>Name</th><th>Act</th></tr></thead><tbody id="userTable"></tbody></table></div></div></div>
        <div class="col-12"><div class="panel-card p-3"><h6 class="fw-bold mb-3 text-success">Dropdowns</h6><div class="row g-2"><div class="col-auto"><select id="dd_cat" class="form-select"><option value="client">Client</option><option value="network">Network</option><option value="destination">Dest</option><option value="extra">Charge</option></select></div><div class="col"><input id="dd_val" class="form-control" placeholder="Value"></div><div class="col-auto"><button class="btn btn-success" onclick="manageDd('add')">Add</button><button class="btn btn-danger" onclick="manageDd('delete')">Del</button></div></div></div></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reassignModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">Transfer Task</h6></div><div class="modal-body"><p class="small text-muted">Transfer <b id="reassignId"></b> to:</p><select id="reassignStaff" class="form-select mb-3"></select><button class="btn btn-primary w-100 btn-sm" onclick="submitReassign()">Send Request</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
  // API CONFIG
  const API_URL="https://script.google.com/macros/s/AKfycbwBjoV46m3wTuitwgaTGunQd9KvltP27be_oKn_6ZeSAwK7qna1B99AxtEu44QR_98EGQ/exec";
  let currentUser="", currentRole="", tsClient, tsDest, currentReassign={};
  
  window.APP_DATA = { staff: [], dropdowns: {}, overview: { auto:[], paper:[] }, workflow: { toAssign:[], toDo:[] }, stats: {} };
  window.tomInstances = { client: null, dest: null };

  // --- GLOBALS ---
  window.loadOverview = function() { renderOverview(); };
  window.loadTaskHub = function() { renderTaskHub(); };
  window.loadAdminPanel = function() { if(currentRole==='admin') { loadUsers(); loadAdminReqs(); } };
  window.genBoxes = function() {
    const n = document.getElementById('f_boxes').value;
    if(!n || n<1) return alert("Enter Total Boxes first");
    const tb = document.getElementById('boxTable'); tb.innerHTML='';
    for(let i=1; i<=n; i++) tb.innerHTML += `<tr><td>${i}</td><td><input type="number" class="form-control form-control-sm" required oninput="cBox(this)"></td><td><input type="number" class="form-control form-control-sm" oninput="cBox(this)"></td><td><input type="number" class="form-control form-control-sm" oninput="cBox(this)"></td><td><input type="number" class="form-control form-control-sm" oninput="cBox(this)"></td><td class="text-end val-chg small fw-bold">0.00</td></tr>`;
  };
  window.cBox = function(el) {
    const r=el.closest('tr'), i=r.querySelectorAll('input');
    const w=parseFloat(i[0].value)||0, l=parseFloat(i[1].value)||0, b=parseFloat(i[2].value)||0, h=parseFloat(i[3].value)||0;
    const chg=Math.max(w, (l*b*h)/5000); r.querySelector('.val-chg').textContent=chg.toFixed(2);
    let tot=0; document.querySelectorAll('.val-chg').forEach(x=>tot+=parseFloat(x.textContent));
    document.getElementById('f_totalChg').value=tot.toFixed(2);
  };
  window.logout = function() { location.reload(); };

  function showSpin(x){document.getElementById('spinner').style.display=x?'flex':'none';}
  async function callApi(d){ try{const r=await fetch(API_URL,{method:"POST",body:JSON.stringify(d)}); return await r.json();}catch(e){return{result:"error"};}}
  async function fetchGet(a){ try{const r=await fetch(`${API_URL}?action=${a}&user=${currentUser}`); return await r.json();}catch(e){return{result:"error"};}}

  // --- LOGIN ---
  async function doLogin(){
    showSpin(true);
    const u=document.getElementById('uIn').value, p=document.getElementById('pIn').value;
    const r=await callApi({action:"login", username:u, password:p});
    if(r.result==="success"){
      currentUser=r.username; currentRole=r.role.toLowerCase();
      document.getElementById('userBadge').textContent=r.name;
      document.getElementById('loginSection').style.display='none';
      document.getElementById('appSection').style.display='block';
      buildNav();
      await syncData(true);
    } else { showSpin(false); document.getElementById('loginError').textContent=r.message; document.getElementById('loginError').style.display='block'; }
  }
  window.doLogin = doLogin;

  // --- DATA SYNC ---
  async function syncData(firstLoad=false){
    if(firstLoad) showSpin(true);
    try {
      const url = `${API_URL}?action=getAllData&user=${currentUser}`;
      const r = await fetch(url).then(res => res.json());
      if(r.result === "success") {
        window.APP_DATA = { ...window.APP_DATA, ...r };
        
        if(r.static) {
            window.APP_DATA.staff = r.static.staff || [];
            window.APP_DATA.dropdowns = r.static.dropdowns || {};
        }

        if(r.workflow) {
          window.APP_DATA.workflow.toAssign = r.workflow.toAssign || [];
          window.APP_DATA.workflow.toDo = r.workflow.toDo || [];
          window.APP_DATA.workflow.history = r.workflow.history || [];
        }
        
        if(firstLoad) {
          initForms();
          setInterval(()=>syncData(false), 30000);
        } else {
          updateDropdowns();
        }
        refreshUI();
      }
    } catch(e) { console.error("Sync Failed", e); }
    if(firstLoad) showSpin(false);
  }

  function refreshUI() {
    renderOverview();
    renderTaskHub();
    if(currentRole==='admin') {
      const c = window.APP_DATA.stats.requests || 0; 
      const b = document.getElementById('adminBadge');
      b.textContent = c;
      b.style.display = c > 0 ? 'inline-block' : 'none';
      loadAdminReqs();
    }
  }

  // --- RENDERERS ---
  function renderOverview() {
    const d = window.APP_DATA.overview;
    const s = window.APP_DATA.stats;
    
    document.getElementById('ovDate').textContent = new Date().toLocaleDateString();
    document.getElementById('ovInbound').textContent = s.inbound;
    document.getElementById('ovAuto').textContent = d.auto.length;
    document.getElementById('ovPaper').textContent = d.paper.length;
    
    const fill = (id, list) => {
      const el=document.getElementById(id); el.innerHTML='';
      if(!list.length) el.innerHTML='<div class="text-center p-3 text-muted small">All clear!</div>';
      list.forEach(x => {
        let userBadge = x.user ? `<div class="small text-secondary mb-1"><i class="bi bi-person me-1"></i>${x.user}</div>` : '';
        let assigneeBadge = x.assignee ? `<div class="small text-success fw-bold mb-1"><i class="bi bi-check-circle-fill me-1"></i>Assigned to: ${x.assignee}</div>` : (x.autoDoer ? `<div class="small text-secondary mb-1"><i class="bi bi-robot me-1"></i>Auto by: ${x.autoDoer}</div>` : '');
        let netHtml = x.netNo ? ` | Net# ${x.netNo}` : '';

        el.innerHTML += `
          <div class="list-group-item">
            <div class="d-flex justify-content-between fw-bold"><span>${x.id}</span><small class="text-muted">${x.net}</small></div>
            <div class="small fw-bold">${x.client}</div>
            ${userBadge}
            ${assigneeBadge}
            <div class="small text-primary">${x.details}${netHtml}</div>
          </div>`;
      });
    };
    fill('listAuto', d.auto);
    
    const sortedPaper = [...d.paper].sort((a,b) => (a.assignee ? 1 : -1) - (b.assignee ? 1 : -1));
    fill('listPaper', sortedPaper);
  }

  function renderTaskHub() {
    if(currentRole === 'admin') {
      const tb = document.getElementById('poolTable'); tb.innerHTML='';
      // FIX: Use adminPool (paperwork only) for Admin Task Manager
      const pool = window.APP_DATA.adminPool || window.APP_DATA.overview.paper || [];
      
      pool.forEach(t => {
        let opts = `<option value="">Assign...</option>`;
        if(window.APP_DATA.staff) window.APP_DATA.staff.forEach(s => opts += `<option value="${s}">${s}</option>`);
        tb.innerHTML += `<tr><td>${t.id}</td><td><span class="badge ${t.type==='Automation'?'bg-danger':'bg-warning text-dark'}">${t.type}</span></td><td><small>${t.details}</small></td><td><select id="as_${t.id}" class="form-select form-select-sm">${opts}</select></td><td><button class="btn btn-sm btn-success" onclick="actAssign('${t.id}','${t.type}')">✓</button></td></tr>`;
      });
    } else {
      const toAssign = window.APP_DATA.workflow.toAssign;
      const toDo = window.APP_DATA.workflow.toDo;
      
      const ac = document.getElementById('staffAssignContainer'); ac.innerHTML='';
      document.getElementById('noAssignMsg').style.display = toAssign.length===0?'block':'none';
      toAssign.forEach(t => {
        let opts = `<option value="">Assign Paperwork To...</option>`;
        if(window.APP_DATA.staff) window.APP_DATA.staff.forEach(s => opts += `<option value="${s}">${s}</option>`);
        ac.innerHTML += `
          <div class="task-card-horizontal" id="assign_card_${t.id}">
            <div><strong class="fs-5">${t.id}</strong><div class="small fw-bold text-secondary">${t.client}</div><div class="small text-muted">${t.net} | ${t.details}</div></div>
            <div class="d-flex gap-2 align-items-center">
              <select id="staff_assign_${t.id}" class="form-select form-select-sm" style="width:160px">${opts}</select>
              <button class="btn btn-primary btn-sm" onclick="staffActAssign('${t.id}')">Assign</button>
            </div>
          </div>`;
      });

      const tc = document.getElementById('staffTodoContainer'); tc.innerHTML='';
      document.getElementById('noTodoMsg').style.display = toDo.length===0?'block':'none';
      toDo.forEach(t => {
        tc.innerHTML += `
          <div class="task-card-horizontal" id="todo_card_${t.id}">
            <div><span class="badge bg-warning text-dark mb-1">Assigned to Me</span><br><strong>${t.id}</strong><div class="small">${t.subtitle}</div><div class="small text-muted">${t.details}</div></div>
            <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm px-4" onclick="staffActDone('${t.id}')">Mark Done</button>
                <button class="btn btn-outline-secondary btn-sm px-3" onclick="reqTransfer('${t.id}','${t.type}')">Transfer</button>
            </div>
          </div>`;
      });
    }
  }

  // --- ACTIONS ---
  async function actAssign(id, type) {
    const s = document.getElementById('as_'+id).value; if(!s) return alert("Select Staff");
    document.getElementById('as_'+id).closest('tr').remove();
    await callApi({action:"assignTask", id:id, type:type, staff:s, assigner:currentUser});
    syncData(false);
  }
  window.actAssign = actAssign;

  async function staffActAssign(id) {
    const s = document.getElementById('staff_assign_'+id).value; if(!s) return alert("Select Staff");
    document.getElementById('assign_card_'+id).remove();
    await callApi({action:"assignTask", id:id, type:"Paperwork", staff:s, assigner:currentUser});
    syncData(false);
  }
  window.staffActAssign = staffActAssign;

  async function staffActDone(id) {
    if(!confirm("Paperwork Completed?")) return;
    document.getElementById('todo_card_'+id).remove();
    await callApi({action:"markPaperworkDone", id:id});
    syncData(false);
  }
  window.staffActDone = staffActDone;

  // --- ADMIN PANEL ---
  async function loadUsers() {
    const r = await fetchGet("getUsers");
    if(r.result==='success'){
      const t = document.getElementById('userTable'); t.innerHTML='';
      if(r.users) r.users.forEach(u => {
        // Password column with toggle logic
        t.innerHTML += `
          <tr>
            <td>${u[0]}</td>
            <td class="text-muted small" style="font-family:monospace; cursor:pointer; user-select:none;" onclick="this.textContent=this.textContent==='****'?'${u[1]}':'****'" title="Click to reveal">****</td>
            <td><small>${u[2]}</small></td>
            <td><button class="btn btn-danger btn-sm py-0" onclick="delUser('${u[0]}')">×</button></td>
          </tr>`;
      });
    }
  }

  async function loadAdminReqs(){
    const r = await fetchGet("getAdminRequests");
    const el = document.getElementById('adminReqList'); el.innerHTML='';
    if(r.requests && r.requests.length > 0) {
      r.requests.forEach(x => {
        // Now displaying Task Type inside the badge
        el.innerHTML += `
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <small>
               <b>${x.taskId}</b> 
               <span class="badge bg-secondary text-light ms-1" style="font-size:0.65rem">${x.type}</span>
               <br>
               ${x.by} <i class="bi bi-arrow-right"></i> ${x.to}
            </small>
            <div>
               <button class="btn btn-sm btn-outline-success py-0" onclick="decideTr(${x.reqId},'${x.taskId}','${x.type}','${x.to}','Approve')">✓</button>
               <button class="btn btn-sm btn-outline-danger py-0" onclick="decideTr(${x.reqId},'${x.taskId}','${x.type}','${x.to}','Reject')">✕</button>
            </div>
          </div>`;
      });
    } else {
      el.innerHTML = '<div class="text-center p-3 text-muted small">No pending requests</div>';
    }
  }

  // --- UTILS ---
  function initForms() {
    const dd = window.APP_DATA.dropdowns || {};
    fillSel('f_net', dd.networks || []); 
    
    // Init TomSelect
    if(dd.clients) {
      window.tomInstances.client = new TomSelect("#f_client",{create:false, dropdownParent: 'body', placeholder: "Search Client..."});
    }
    if(dd.destinations) {
      window.tomInstances.dest = new TomSelect("#f_dest",{create:false, dropdownParent: 'body', placeholder: "Search Dest..."});
    }
    
    updateDropdownOptions();
    
    const ex = document.getElementById('f_extra'); ex.innerHTML='';
    if(dd.extraCharges) {
        dd.extraCharges.forEach(x => ex.innerHTML += `<div class="form-check form-check-inline bg-light border px-2 py-1 rounded small"><input class="form-check-input" type="checkbox" value="${x}"><label class="form-check-label ms-1">${x}</label></div>`);
    }
    document.getElementById('f_date').valueAsDate = new Date();
  }

  function updateDropdowns() {
    const dd = window.APP_DATA.dropdowns || {};
    fillSel('f_net', dd.networks || []);
    updateDropdownOptions();
    
    const ex = document.getElementById('f_extra'); ex.innerHTML='';
    if(dd.extraCharges) {
        dd.extraCharges.forEach(x => ex.innerHTML += `<div class="form-check form-check-inline bg-light border px-2 py-1 rounded small"><input class="form-check-input" type="checkbox" value="${x}"><label class="form-check-label ms-1">${x}</label></div>`);
    }
  }

  function updateDropdownOptions() {
    const dd = window.APP_DATA.dropdowns || {};
    if(window.tomInstances.client && dd.clients) {
      window.tomInstances.client.clearOptions();
      dd.clients.forEach(c => window.tomInstances.client.addOption({value:c, text:c}));
      window.tomInstances.client.refreshOptions(false);
    }
    if(window.tomInstances.dest && dd.destinations) {
      window.tomInstances.dest.clearOptions();
      dd.destinations.forEach(d => window.tomInstances.dest.addOption({value:d, text:d}));
      window.tomInstances.dest.refreshOptions(false);
    }
  }

  function buildNav() {
    const nav = document.getElementById('mainNav');
    const tabs = {
      inb: document.getElementById('nav-inbound'),
      over: document.getElementById('nav-overview'),
      task: document.getElementById('nav-taskhub'),
      adm: document.getElementById('nav-admin')
    };
    
    const taskLabel = document.getElementById('taskHubLabel');
    taskLabel.textContent = currentRole === 'admin' ? "Task Manager" : "Work Panel";

    if(currentRole === 'admin') {
      nav.append(tabs.over, tabs.inb, tabs.task, tabs.adm);
      tabs.adm.style.display='block';
      new bootstrap.Tab(tabs.over.querySelector('button')).show();
      document.getElementById('adminTaskView').style.display='block';
      loadAdminPanel();
    } else {
      nav.append(tabs.inb, tabs.over, tabs.task);
      tabs.adm.style.display='none';
      new bootstrap.Tab(tabs.inb.querySelector('button')).show();
      document.getElementById('staffTaskView').style.display='block';
    }
  }

  document.getElementById('shipForm').onsubmit = async (e) => {
    e.preventDefault();
    if(!document.getElementById('f_net').value || !document.getElementById('f_client').value || !document.getElementById('f_dest').value) return alert("Fill Dropdowns");
    
    showSpin(true); 
    let boxes=[], extra=[]; 
    document.querySelectorAll('#boxTable tr').forEach((tr,i)=>{
       let inps=tr.querySelectorAll('input');
       if(inps.length) boxes.push({no:i+1, weight:inps[0].value, length:inps[1].value, breath:inps[2].value, height:inps[3].value});
    });
    document.querySelectorAll('#f_extra input:checked').forEach(c=>extra.push(c.value));
    
    const res = await callApi({ 
      action: 'submit', username: currentUser, awb: document.getElementById('f_awb').value, 
      date: document.getElementById('f_date').value, type: document.getElementById('f_type').value, 
      network: document.getElementById('f_net').value, client: document.getElementById('f_client').value, 
      destination: document.getElementById('f_dest').value, totalBoxes: document.getElementById('f_boxes').value, 
      extraCharges: extra.join(', '), extraRemarks: document.getElementById('f_remarks').value, boxes: boxes 
    });
    showSpin(false);
    if(res.result==='success') { 
      alert("Saved!"); document.getElementById('shipForm').reset(); document.getElementById('boxTable').innerHTML=''; tsClient.clear(); tsDest.clear();
      syncData(false); 
    } else alert(res.message);
  };

  async function manageDd(act){
    const v=document.getElementById('dd_val').value, c=document.getElementById('dd_cat').value; if(!v)return;
    await callApi({action:"manageData", subAction:act, category:c, value:v});
    document.getElementById('dd_val').value=''; syncData(false);
  }
  window.manageDd = manageDd;

  async function decideTr(rid, tid, typ, to, dec){ showSpin(true); await callApi({action:"approveTransfer", reqId:rid, taskId:tid, type:typ, to:to, decision:dec}); loadAdminReqs(); showSpin(false); }
  window.decideTr = decideTr;

  async function addUser() { await callApi({action:"addUser", u:document.getElementById('nu_u').value, p:document.getElementById('nu_p').value, n:document.getElementById('nu_n').value, r:document.getElementById('nu_r').value}); loadUsers(); }
  window.addUser = addUser;

  async function delUser(u) { if(confirm("Del?")) await callApi({action:"deleteUser", username:u}); loadUsers(); }
  window.delUser = delUser;
  
  function fillSel(id, arr) { 
    let e=document.getElementById(id); 
    e.innerHTML='<option value="">Select...</option>'; 
    if(arr) {
        let opts = '';
        arr.forEach(x=>opts+=`<option value="${x}">${x}</option>`);
        e.innerHTML += opts;
    }
  }
  
  function submitReassign() {
    const to = document.getElementById('reassignStaff').value; if(!to) return;
    bootstrap.Modal.getInstance(document.getElementById('reassignModal')).hide();
    alert("Request Sent!"); 
    callApi({action:"requestTransfer", taskId:currentReassign.id, type:currentReassign.type, by:currentUser, to:to});
  }
  window.submitReassign = submitReassign;

  function reqTransfer(id, type){
    currentReassign={id:id, type:type};
    document.getElementById('reassignId').textContent=id;
    const s=document.getElementById('reassignStaff'); s.innerHTML='<option value="">Select...</option>';
    if(window.APP_DATA.staff) window.APP_DATA.staff.forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`);
    new bootstrap.Modal(document.getElementById('reassignModal')).show();
  }
  window.reqTransfer = reqTransfer;
</script>
</body>
</html>
