<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unified Logistics Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
  
  <link rel="icon" href="https://raw.githubusercontent.com/zephyrexpress/Booking/main/Icon.png">

  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', system-ui, sans-serif; }
    .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .login-card { width: 100%; max-width: 400px; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .main-container { max-width: 1400px; margin: 30px auto; padding: 0 15px; display: none; }
    
    /* Tabs Styling */
    .nav-tabs .nav-link { color: #555; font-weight: 500; border: none; border-bottom: 3px solid transparent; }
    .nav-tabs .nav-link.active { color: #0d6efd; background: transparent; border-bottom: 3px solid #0d6efd; font-weight: bold; }
    .tab-content { background: white; padding: 30px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
    
    /* Table Styling */
    .table thead { background-color: #0d6efd; color: white; }
    .table th { font-weight: 600; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; vertical-align: middle; }
    .table td { vertical-align: middle; font-size: 0.95rem; }
    
    /* Pending Dropdown Style */
    .pending-alert { color: #dc3545; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
    
    /* Spinner */
    .spinner-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:none; justify-content:center; align-items:center; backdrop-filter: blur(3px); }
    
    /* Images */
    .logo-login { height: 80px; object-fit: contain; }
    .logo-header { height: 45px; object-fit: contain; }
  </style>
</head>
<body>

<div id="spinner" class="spinner-overlay">
  <div class="text-center">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-dark">Processing...</div>
  </div>
</div>

<div id="loginSection" class="login-wrapper">
  <div class="login-card">
    <div class="text-center mb-4">
      <img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" alt="Logo" class="logo-login">
    </div>
    <h4 class="text-center mb-4 fw-bold text-secondary">Portal Access</h4>
    
    <form onsubmit="event.preventDefault(); doLogin();">
      <div class="mb-3">
        <input type="text" id="uIn" class="form-control form-control-lg" placeholder="Username" required>
      </div>
      <div class="mb-4">
        <input type="password" id="pIn" class="form-control form-control-lg" placeholder="Password" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">LOGIN</button>
    </form>
    <div id="loginError" class="alert alert-danger mt-3 text-center small" style="display:none;"></div>
  </div>
</div>

<div id="appSection" class="main-container">
  
  <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
    <div class="d-flex align-items-center">
      <img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" alt="Logo" class="logo-header me-3">
      <div class="border-start ps-3">
        <h5 class="m-0 fw-bold text-primary">Unified Portal</h5>
        <small class="text-muted" id="userBadge">User</small>
      </div>
    </div>
    <button onclick="logout()" class="btn btn-outline-danger btn-sm px-4 fw-bold">Logout</button>
  </div>

  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dash-content">
        üìã Task Dashboard
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#form-content">
        üì¶ Shipment Inbound
      </button>
    </li>
    <li class="nav-item" id="adminTabLi" style="display:none;">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin-content">
        ‚öôÔ∏è Admin Settings
      </button>
    </li>
  </ul>

  <div class="tab-content shadow-sm">
    
    <div class="tab-pane fade show active" id="dash-content">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="m-0 fw-bold">Pending Tasks: <span id="taskCount" class="badge bg-danger rounded-pill">0</span></h5>
        <button class="btn btn-sm btn-dark shadow-sm px-3" onclick="loadDashboard()">üîÑ Refresh Data</button>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover align-middle table-bordered">
          <thead class="table-primary">
            <tr>
              <th>AWB</th>
              <th>Client</th>
              <th>Network</th>
              <th>Weight</th>
              <th>Automated By</th> 
              
              <th>Network No.</th>
              
              <th style="width: 220px;">Assign To</th>
              <th style="width: 100px;">Action</th>
            </tr>
          </thead>
          <tbody id="dashTable"></tbody>
        </table>
        <div id="noDashData" class="alert alert-success text-center py-4 fw-bold" style="display:none;">
           All caught up! No pending tasks. ‚úÖ
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="form-content">
      <form id="shipForm">
        <h5 class="mb-4 text-primary fw-bold border-bottom pb-2">Shipment Inbound</h5>
        <div class="row g-3">
          <div class="col-md-4"><label class="form-label small fw-bold">AWB Number</label><input type="text" id="f_awb" class="form-control" required></div>
          <div class="col-md-4"><label class="form-label small fw-bold">Date</label><input type="date" id="f_date" class="form-control" required></div>
          <div class="col-md-4"><label class="form-label small fw-bold">Type</label><select id="f_type" class="form-select"><option>Dox</option><option>Ndox</option></select></div>
          
          <div class="col-md-4"><label class="form-label small fw-bold">Network</label><select id="f_net" class="form-select"></select></div>
          <div class="col-md-4"><label class="form-label small fw-bold">Client</label><select id="f_client" placeholder="Search..."></select></div>
          <div class="col-md-4"><label class="form-label small fw-bold">Destination</label><select id="f_dest" placeholder="Search..."></select></div>
          
          <div class="col-md-6"><label class="form-label small fw-bold">Total Boxes</label><input type="number" id="f_boxes" class="form-control" min="1" required></div>
          <div class="col-md-6"><label class="form-label small fw-bold">Chargeable Weight</label><input type="text" id="f_totalChg" class="form-control bg-light fw-bold text-success" readonly value="0.00"></div>
        </div>

        <div class="mt-4 p-3 bg-light rounded border">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong class="text-secondary">Box Dimensions</strong>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="genBoxes()">Generate Rows</button>
          </div>
          <table class="table table-sm bg-white mb-0">
            <thead><tr><th>No</th><th>Weight</th><th>Length</th><th>Breadth</th><th>Height</th><th>Vol. Wgt</th></tr></thead>
            <tbody id="boxTable"></tbody>
          </table>
        </div>

        <div class="mt-3">
          <label class="form-label small fw-bold">Extra Charges</label>
          <div id="f_extra" class="d-flex flex-wrap gap-3 p-3 border rounded bg-white">Loading...</div>
        </div>
        
        <div class="mt-3">
          <label class="form-label small fw-bold">Remarks</label>
          <textarea id="f_remarks" class="form-control" rows="2"></textarea>
        </div>

        <button type="submit" class="btn btn-success w-100 mt-4 py-2 fw-bold shadow-sm">SUBMIT INBOUND</button>
      </form>
    </div>

    <div class="tab-pane fade" id="admin-content">
      <h5 class="mb-4 text-primary fw-bold border-bottom pb-2">Admin Settings</h5>
      <div class="row">
        <div class="col-md-6">
          <div class="card shadow-sm mb-3">
            <div class="card-header bg-white fw-bold">üë§ User Accounts</div>
            <div class="card-body">
              <div class="input-group mb-3">
                <input type="text" id="nu_u" class="form-control form-control-sm" placeholder="User">
                <input type="text" id="nu_p" class="form-control form-control-sm" placeholder="Pass">
                <input type="text" id="nu_n" class="form-control form-control-sm" placeholder="Name">
                <select id="nu_r" class="form-select form-select-sm"><option>Staff</option><option>Admin</option></select>
                <button class="btn btn-success btn-sm" onclick="addUser()">+</button>
              </div>
              <div style="max-height:300px; overflow-y:auto;">
                <table class="table table-sm table-striped mb-0">
                  <thead class="table-dark small"><tr><th>User</th><th>Pass</th><th>Name</th><th>Role</th><th>Del</th></tr></thead>
                  <tbody id="userTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-white fw-bold">üìù Dropdown Lists</div>
            <div class="card-body">
              <select id="dd_cat" class="form-select mb-2">
                <option value="client">Client Codes</option>
                <option value="destination">Destinations</option>
                <option value="network">Network Types</option>
                <option value="extra">Extra Charges</option>
              </select>
              <div class="input-group">
                <input type="text" id="dd_val" class="form-control" placeholder="New Value">
                <button class="btn btn-success" onclick="manageDd('add')">Add</button>
                <button class="btn btn-danger" onclick="manageDd('delete')">Del</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
  // ******************************************************
  // ‚úÖ YOUR API URL
  const API_URL = "https://script.google.com/macros/s/AKfycbwBjoV46m3wTuitwgaTGunQd9KvltP27be_oKn_6ZeSAwK7qna1B99AxtEu44QR_98EGQ/exec"; 
  // ******************************************************

  let currentUser = "", currentRole = "", staffList = [];
  let tsClient, tsDest; 

  // --- API HANDLER ---
  async function callApi(data) {
    document.getElementById('spinner').style.display = 'flex';
    try {
      const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
      const result = await response.json();
      document.getElementById('spinner').style.display = 'none';
      return result;
    } catch (e) {
      document.getElementById('spinner').style.display = 'none';
      alert("Connection Error.");
      return { result: "error", message: "Connection Failed" };
    }
  }
  
  async function fetchGet(action) {
    // Note: Not showing spinner for parallel fetches to avoid flickering, handled by parent
    try {
      const response = await fetch(`${API_URL}?action=${action}&user=${currentUser}`);
      return await response.json();
    } catch (e) { return { result: "error" }; }
  }

  // --- LOGIN ---
  async function doLogin() {
    const u = document.getElementById('uIn').value;
    const p = document.getElementById('pIn').value;
    if(!u || !p) return alert("Enter credentials");

    const res = await callApi({ action: "login", username: u, password: p });
    
    if(res.result === "success") {
      currentUser = res.username;
      currentRole = res.role.toLowerCase();
      
      document.getElementById('userBadge').textContent = res.name + " (" + res.role + ")";
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
      
      if(currentRole === 'admin') {
        document.getElementById('adminTabLi').style.display = 'block';
        loadUsers();
      }
      initApp();
    } else {
      const errDiv = document.getElementById('loginError');
      errDiv.textContent = res.message;
      errDiv.style.display = 'block';
    }
  }

  // --- APP INITIALIZATION (FASTER!) ---
  async function initApp() {
    document.getElementById('spinner').style.display = 'flex';
    document.getElementById('f_date').valueAsDate = new Date();

    // PARALLEL FETCHING: Get Staff AND Dropdowns at the same time
    const [staffRes, dropRes] = await Promise.all([
      fetchGet("getStaff"),
      fetchGet("getDropdowns")
    ]);

    // Handle Staff
    if(staffRes.result === "success") {
      staffList = staffRes.list;
      loadDashboard(false); // Don't spin again
    }

    // Handle Dropdowns
    if(dropRes.result === "success") {
      fillSel('f_net', dropRes.networks);
      fillSel('f_client', dropRes.clients);
      fillSel('f_dest', dropRes.destinations);
      fillCheck('f_extra', dropRes.extraCharges);
      
      if(tsClient) tsClient.destroy();
      if(tsDest) tsDest.destroy();
      tsClient = new TomSelect("#f_client",{create:false});
      tsDest = new TomSelect("#f_dest",{create:false});
    }

    document.getElementById('spinner').style.display = 'none';
  }

  // --- DASHBOARD ---
  async function loadDashboard(showLoader = true) {
    if(showLoader) document.getElementById('spinner').style.display = 'flex';
    
    const res = await fetchGet("getDashboard");
    const tb = document.getElementById('dashTable'); 
    tb.innerHTML = '';
    
    if(showLoader) document.getElementById('spinner').style.display = 'none';

    if(res.result === "success") {
      document.getElementById('taskCount').textContent = res.count;
      document.getElementById('noDashData').style.display = res.count===0 ? 'block' : 'none';
      
      // Server Data Order: 
      // 0:AWB, 1:Client, 2:Network, 3:NetNo, 4:Weight, 5:AllocatedBy
      
      res.tasks.forEach(row => {
        let tr = document.createElement('tr');
        
        // 1. REORDERED DATA DISPLAY
        // Target: AWB(0), Client(1), Network(2), Weight(4), AutoBy(5), NetNo(3)
        const displayOrder = [0, 1, 2, 4, 5, 3];
        
        displayOrder.forEach(idx => {
          let td = document.createElement('td'); 
          td.textContent = row[idx];
          tr.appendChild(td); 
        });
        
        // 2. ASSIGN DROP DOWN (With Red Pending)
        let tdSel = document.createElement('td');
        let sel = document.createElement('select'); 
        sel.className = "form-select form-select-sm fw-bold";
        
        // Custom "Pending" Option
        let defaultOpt = document.createElement('option');
        defaultOpt.value = "";
        defaultOpt.innerHTML = "‚ö†Ô∏è PENDING";
        defaultOpt.className = "pending-alert";
        sel.appendChild(defaultOpt);

        staffList.forEach(s => {
          let opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          opt.className = "text-dark fw-normal"; // Normal style for names
          sel.appendChild(opt);
        });

        // Toggle Color logic
        sel.style.color = "#dc3545"; // Default Red
        sel.onchange = function() {
           this.style.color = this.value === "" ? "#dc3545" : "#212529";
        };

        tdSel.appendChild(sel); 
        tr.appendChild(tdSel);
        
        // 3. ACTION BUTTON
        let tdBtn = document.createElement('td');
        let btn = document.createElement('button'); 
        btn.className = "btn btn-success btn-sm w-100 fw-bold"; 
        btn.textContent = "‚úì Assign";
        
        btn.onclick = async () => {
          if(!sel.value) return alert("Please select a staff member first.");
          btn.textContent = "..."; btn.disabled = true;
          
          const assignRes = await callApi({ 
            action: "assignTask", 
            awb: row[0], 
            staff: sel.value, 
            assigner: currentUser 
          });
          
          if(assignRes.result === "success") {
            tr.remove(); 
            let c = document.getElementById('taskCount'); 
            c.textContent = Math.max(0, parseInt(c.textContent) - 1);
          } else { 
            alert(assignRes.message); 
            btn.textContent = "Assign"; btn.disabled = false;
          }
        };
        tdBtn.appendChild(btn); 
        tr.appendChild(tdBtn);
        
        tb.appendChild(tr);
      });
    }
  }

  // --- FORM LOGIC ---
  function genBoxes() {
    let n = document.getElementById('f_boxes').value;
    let tb = document.getElementById('boxTable'); tb.innerHTML='';
    for(let i=1; i<=n; i++) {
      tb.innerHTML += `<tr><td>${i}</td><td><input type="number" class="form-control form-control-sm" step="0.01" oninput="calcBox(this)"></td><td><input type="number" class="form-control form-control-sm" step="0.1" oninput="calcBox(this)"></td><td><input type="number" class="form-control form-control-sm" step="0.1" oninput="calcBox(this)"></td><td><input type="number" class="form-control form-control-sm" step="0.1" oninput="calcBox(this)"></td><td class="chg-val fw-bold text-success">0.00</td></tr>`;
    }
  }
  function calcBox(el) {
    let tr = el.closest('tr'); let inps = tr.querySelectorAll('input');
    let w=parseFloat(inps[0].value)||0, l=parseFloat(inps[1].value)||0, b=parseFloat(inps[2].value)||0, h=parseFloat(inps[3].value)||0;
    let chg = Math.max(w, (l*b*h)/5000).toFixed(2);
    tr.querySelector('.chg-val').textContent = chg;
    let tot=0; document.querySelectorAll('.chg-val').forEach(e => tot += parseFloat(e.textContent));
    document.getElementById('f_totalChg').value = tot.toFixed(2);
  }
  document.getElementById('shipForm').onsubmit = async (e) => {
    e.preventDefault();
    let boxes=[]; document.querySelectorAll('#boxTable tr').forEach((tr,i)=>{ let inps=tr.querySelectorAll('input'); if(inps.length>0) boxes.push({no:i+1, weight:inps[0].value, length:inps[1].value, breath:inps[2].value, height:inps[3].value}); });
    let extra=[]; document.querySelectorAll('#f_extra input:checked').forEach(c=>extra.push(c.value));
    const res = await callApi({ action: 'submit', username: currentUser, awb: document.getElementById('f_awb').value, date: document.getElementById('f_date').value, type: document.getElementById('f_type').value, network: document.getElementById('f_net').value, client: document.getElementById('f_client').value, destination: document.getElementById('f_dest').value, totalBoxes: document.getElementById('f_boxes').value, extraCharges: extra.join(', '), extraRemarks: document.getElementById('f_remarks').value, boxes: boxes });
    if(res.result==='success') { alert("‚úÖ Inbound Saved!"); document.getElementById('shipForm').reset(); document.getElementById('boxTable').innerHTML=''; tsClient.clear(); tsDest.clear(); } else alert("‚ùå "+res.message);
  };

  // --- ADMIN ---
  async function loadUsers() {
    const res = await fetchGet("getUsers");
    if(res.result==="success") {
      let tb = document.getElementById('userTable'); tb.innerHTML='';
      res.users.forEach(u => {
        tb.innerHTML += `<tr><td>${u[0]}</td><td>${u[1]}</td><td>${u[2]}</td><td><span class="badge bg-light text-dark border">${u[3]}</span></td><td><button class="btn btn-danger btn-sm p-0 px-2" onclick="delUser('${u[0]}')">&times;</button></td></tr>`;
      });
    }
  }
  async function addUser() {
    const res = await callApi({action:"addUser", u:document.getElementById('nu_u').value, p:document.getElementById('nu_p').value, n:document.getElementById('nu_n').value, r:document.getElementById('nu_r').value});
    alert(res.message); if(res.result==="success") loadUsers();
  }
  async function delUser(u) { if(confirm("Delete user?")) { await callApi({action:"deleteUser", username:u}); loadUsers(); } }
  async function manageDd(act) {
    const v = document.getElementById('dd_val').value; if(!v) return;
    const res = await callApi({action:'manageData', subAction:act, category:document.getElementById('dd_cat').value, value:v});
    alert(res.message); if(res.result==='success') { document.getElementById('dd_val').value=''; initApp(); }
  }

  // Helpers
  function fillSel(id, arr) { let e=document.getElementById(id); e.innerHTML='<option value="">Select...</option>'; arr.forEach(x=>e.innerHTML+=`<option value="${x}">${x}</option>`); }
  function fillCheck(id, arr) { let e=document.getElementById(id); e.innerHTML=''; arr.forEach(x=>e.innerHTML+=`<div class="form-check"><input class="form-check-input" type="checkbox" value="${x}"><label class="form-check-label">${x}</label></div>`); }
  function logout() { location.reload(); }
</script>
</body>
</html>
