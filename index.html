<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Unified Logistics Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  
  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .login-wrapper { display: flex; justify-content: center; align-items: center; height: 100vh; }
    .login-card { width: 100%; max-width: 400px; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .main-container { max-width: 1400px; margin: 20px auto; display: none; padding: 0 15px; }
    .nav-tabs .nav-link.active { font-weight: bold; border-top: 3px solid #0d6efd; }
    .tab-content { background: white; padding: 25px; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 5px 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .table th { background-color: #0d6efd; color: white; }
    .spinner-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:none; justify-content:center; align-items:center; }
  </style>
</head>
<body>

<div id="spinner" class="spinner-overlay"><div class="spinner-border text-primary" role="status"></div></div>

<div id="loginSection" class="login-wrapper">
  <div class="login-card">
    <h3 class="text-center mb-4 text-primary fw-bold">Logistics Portal</h3>
    <div class="mb-3"><label>Username</label><input type="text" id="uIn" class="form-control"></div>
    <div class="mb-4"><label>Password</label><input type="password" id="pIn" class="form-control"></div>
    <button onclick="doLogin()" id="loginBtn" class="btn btn-primary w-100 py-2">Login</button>
    <p id="loginError" class="text-danger text-center mt-3 small" style="display:none;"></p>
  </div>
</div>

<div id="appSection" class="main-container">
  
  <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 rounded shadow-sm">
    <div class="d-flex align-items-center">
      <h4 class="m-0 fw-bold text-primary me-3">SUPER PORTAL</h4>
      <span class="badge bg-secondary" id="userBadge">User</span>
    </div>
    <button onclick="logout()" class="btn btn-outline-danger btn-sm">Logout</button>
  </div>

  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="dash-tab" data-bs-toggle="tab" data-bs-target="#dash-content" type="button">üìã Task Dashboard</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-content" type="button">üì¶ New Shipment</button>
    </li>
    <li class="nav-item" role="presentation" id="adminTabLi" style="display:none;">
      <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin-content" type="button">‚öôÔ∏è Admin Panel</button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    
    <div class="tab-pane fade show active" id="dash-content">
      <div class="d-flex justify-content-between mb-3">
        <h5>Pending Allocations: <span id="taskCount" class="badge bg-warning text-dark">0</span></h5>
        <button class="btn btn-sm btn-secondary" onclick="loadDashboard()">üîÑ Refresh</button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle table-bordered">
          <thead><tr><th>AWB</th><th>Client</th><th>Network</th><th>NetNo</th><th>Weight</th><th>Allocated By</th><th>Assign To</th><th>Action</th></tr></thead>
          <tbody id="dashTable"></tbody>
        </table>
        <div id="noDashData" class="alert alert-success text-center" style="display:none;">No pending tasks!</div>
      </div>
    </div>

    <div class="tab-pane fade" id="form-content">
      <form id="shipForm">
        <div class="row g-3">
          <div class="col-md-4"><label>AWB</label><input type="text" id="f_awb" class="form-control" required></div>
          <div class="col-md-4"><label>Date</label><input type="date" id="f_date" class="form-control" required></div>
          <div class="col-md-4"><label>Type</label><select id="f_type" class="form-select"><option>Dox</option><option>Ndox</option></select></div>
          
          <div class="col-md-4"><label>Network</label><select id="f_net" class="form-select"></select></div>
          <div class="col-md-4"><label>Client</label><select id="f_client" placeholder="Search..."></select></div>
          <div class="col-md-4"><label>Destination</label><select id="f_dest" placeholder="Search..."></select></div>
          
          <div class="col-md-6"><label>Total Boxes</label><input type="number" id="f_boxes" class="form-control" min="1" required></div>
          <div class="col-md-6"><label>Total Chargeable</label><input type="text" id="f_totalChg" class="form-control bg-light fw-bold" readonly value="0.00"></div>
        </div>

        <div class="mt-4 border p-3 rounded bg-light">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Box Details</strong>
            <button type="button" class="btn btn-primary btn-sm" onclick="genBoxes()">Generate Rows</button>
          </div>
          <table class="table table-sm bg-white">
            <thead><tr><th>No</th><th>Weight</th><th>L</th><th>B</th><th>H</th><th>Chg Wgt</th></tr></thead>
            <tbody id="boxTable"><tr><td colspan="6" class="text-center text-muted">Enter boxes & generate</td></tr></tbody>
          </table>
        </div>

        <div class="mt-3">
          <label>Extra Charges</label>
          <div id="f_extra" class="d-flex flex-wrap gap-3 border p-2 rounded bg-white">Loading...</div>
        </div>
        
        <div class="mt-3">
          <label>Remarks</label>
          <textarea id="f_remarks" class="form-control" rows="2"></textarea>
        </div>

        <button type="submit" class="btn btn-success w-100 mt-4 py-2 fw-bold">SUBMIT SHIPMENT</button>
      </form>
    </div>

    <div class="tab-pane fade" id="admin-content">
      <div class="row">
        <div class="col-md-6">
          <div class="card p-3 mb-3">
            <h6>üë§ Manage Users</h6>
            <div class="input-group mb-2">
              <input type="text" id="nu_u" class="form-control form-control-sm" placeholder="User">
              <input type="text" id="nu_p" class="form-control form-control-sm" placeholder="Pass">
              <input type="text" id="nu_n" class="form-control form-control-sm" placeholder="Name">
              <select id="nu_r" class="form-select form-select-sm"><option>Staff</option><option>Admin</option></select>
              <button class="btn btn-success btn-sm" onclick="addUser()">Add</button>
            </div>
            <div style="max-height:300px; overflow-y:auto;">
              <table class="table table-sm table-striped"><tbody id="userTable"></tbody></table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card p-3">
            <h6>üìù Manage Dropdowns</h6>
            <select id="dd_cat" class="form-select mb-2">
              <option value="client">Client</option>
              <option value="destination">Destination</option>
              <option value="network">Network</option>
              <option value="extra">Extra Charges</option>
            </select>
            <div class="input-group">
              <input type="text" id="dd_val" class="form-control" placeholder="Value">
              <button class="btn btn-success" onclick="manageDd('add')">Add</button>
              <button class="btn btn-danger" onclick="manageDd('delete')">Del</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // CONFIGURATION
  // ******************************************************
  // ‚úÖ URL INSERTED BELOW
  const API_URL = "https://script.google.com/macros/s/AKfycbwBjoV46m3wTuitwgaTGunQd9KvltP27be_oKn_6ZeSAwK7qna1B99AxtEu44QR_98EGQ/exec"; 
  // ******************************************************

  let currentUser = "", currentRole = "", staffList = [];
  let tsClient, tsDest; 

  function showSpin(x) { document.getElementById('spinner').style.display = x ? 'flex' : 'none'; }

  // --- LOGIN ---
  function doLogin() {
    let u = document.getElementById('uIn').value;
    let p = document.getElementById('pIn').value;
    if(!u || !p) return alert("Enter credentials");
    
    showSpin(true);
    google.script.run.withSuccessHandler(res => {
      showSpin(false);
      if(res.valid) {
        currentUser = res.username;
        currentRole = res.role.toLowerCase();
        
        document.getElementById('userBadge').textContent = res.name + " (" + res.role + ")";
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('appSection').style.display = 'block';
        
        // Setup Tabs
        if(currentRole === 'admin') {
          document.getElementById('adminTabLi').style.display = 'block';
          loadUsers();
        }
        
        // Initial Data Load
        initApp(); 
      } else {
        document.getElementById('loginError').textContent = res.error;
        document.getElementById('loginError').style.display = 'block';
      }
    }).verifyLogin(u, p);
  }

  function initApp() {
    // Load Dashboard Staff List
    google.script.run.withSuccessHandler(list => { staffList = list; loadDashboard(); }).getStaffList();
    
    // Load Form Dropdowns (via JSON GET)
    fetch(API_URL + "?type=json").then(r=>r.json()).then(d => {
      fillSel('f_net', d.networks);
      fillSel('f_client', d.clients);
      fillSel('f_dest', d.destinations);
      fillCheck('f_extra', d.extraCharges);
      
      tsClient = new TomSelect("#f_client",{create:false});
      tsDest = new TomSelect("#f_dest",{create:false});
    });
    
    document.getElementById('f_date').valueAsDate = new Date();
  }

  // --- DASHBOARD LOGIC ---
  function loadDashboard() {
    showSpin(true);
    google.script.run.withSuccessHandler(res => {
      showSpin(false);
      const tb = document.getElementById('dashTable');
      tb.innerHTML = '';
      document.getElementById('taskCount').textContent = res.count;
      document.getElementById('noDashData').style.display = res.count===0 ? 'block' : 'none';
      
      res.tasks.forEach(row => {
        let tr = document.createElement('tr');
        // Cols A-F
        for(let i=0; i<6; i++) { let td = document.createElement('td'); td.textContent=row[i]; tr.appendChild(td); }
        
        // Dropdown
        let tdSel = document.createElement('td');
        let sel = document.createElement('select'); sel.className="form-select form-select-sm";
        sel.innerHTML = '<option value="">Select...</option>';
        staffList.forEach(s=>sel.innerHTML+=`<option>${s}</option>`);
        tdSel.appendChild(sel); tr.appendChild(tdSel);
        
        // Button
        let tdBtn = document.createElement('td');
        let btn = document.createElement('button'); btn.className="btn btn-success btn-sm w-100"; btn.textContent="Assign";
        btn.onclick = () => {
          if(!sel.value) return alert("Select staff");
          btn.disabled=true; btn.textContent="...";
          google.script.run.withSuccessHandler(r=>{
            if(r==="Success") { tr.remove(); let c=document.getElementById('taskCount'); c.textContent=parseInt(c.textContent)-1; }
            else { alert(r); btn.disabled=false; }
          }).assignTask(row[0], sel.value, currentUser);
        };
        tdBtn.appendChild(btn); tr.appendChild(tdBtn);
        tb.appendChild(tr);
      });
    }).getUserData(currentUser);
  }

  // --- FORM LOGIC ---
  function genBoxes() {
    let n = document.getElementById('f_boxes').value;
    let tb = document.getElementById('boxTable'); tb.innerHTML='';
    for(let i=1; i<=n; i++) {
      tb.innerHTML += `<tr><td>${i}</td>
      <td><input type="number" class="form-control form-control-sm" oninput="calcBox(this)"></td>
      <td><input type="number" class="form-control form-control-sm" oninput="calcBox(this)"></td>
      <td><input type="number" class="form-control form-control-sm" oninput="calcBox(this)"></td>
      <td><input type="number" class="form-control form-control-sm" oninput="calcBox(this)"></td>
      <td class="chg-val fw-bold">0.00</td></tr>`;
    }
  }

  function calcBox(el) {
    let tr = el.closest('tr');
    let inps = tr.querySelectorAll('input');
    let w=parseFloat(inps[0].value)||0, l=parseFloat(inps[1].value)||0, b=parseFloat(inps[2].value)||0, h=parseFloat(inps[3].value)||0;
    let chg = Math.max(w, (l*b*h)/5000).toFixed(2);
    tr.querySelector('.chg-val').textContent = chg;
    
    // Total
    let tot=0;
    document.querySelectorAll('.chg-val').forEach(e => tot += parseFloat(e.textContent));
    document.getElementById('f_totalChg').value = tot.toFixed(2);
  }

  document.getElementById('shipForm').onsubmit = (e) => {
    e.preventDefault();
    showSpin(true);
    
    // Gather Boxes
    let boxes = [];
    document.querySelectorAll('#boxTable tr').forEach((tr, i) => {
      let inps = tr.querySelectorAll('input');
      if(inps.length>0) boxes.push({no:i+1, weight:inps[0].value, length:inps[1].value, breath:inps[2].value, height:inps[3].value});
    });

    let extra = [];
    document.querySelectorAll('#f_extra input:checked').forEach(c=>extra.push(c.value));

    let payload = {
      action: 'submit',
      username: currentUser,
      awb: document.getElementById('f_awb').value,
      date: document.getElementById('f_date').value,
      type: document.getElementById('f_type').value,
      network: document.getElementById('f_net').value,
      client: document.getElementById('f_client').value,
      destination: document.getElementById('f_dest').value,
      totalBoxes: document.getElementById('f_boxes').value,
      extraCharges: extra.join(', '),
      extraRemarks: document.getElementById('f_remarks').value,
      boxes: boxes
    };

    fetch(API_URL, {method:'POST', body:JSON.stringify(payload)})
    .then(r=>r.json()).then(d=>{
      showSpin(false);
      if(d.result==='success') { alert("Saved!"); document.getElementById('shipForm').reset(); document.getElementById('boxTable').innerHTML=''; tsClient.clear(); tsDest.clear(); }
      else alert(d.message);
    });
  };

  // --- ADMIN LOGIC ---
  function loadUsers() {
    google.script.run.withSuccessHandler(users => {
      let tb = document.getElementById('userTable'); tb.innerHTML='';
      users.forEach(u => {
        tb.innerHTML += `<tr><td>${u[0]}</td><td>${u[2]}</td><td>${u[3]}</td><td><button class="btn btn-danger btn-sm p-0 px-1" onclick="delUser('${u[0]}')">X</button></td></tr>`;
      });
    }).getAllUsers();
  }
  function addUser() {
    google.script.run.withSuccessHandler(r=>{ alert(r); loadUsers(); }).addNewUser(
      document.getElementById('nu_u').value, document.getElementById('nu_p').value, document.getElementById('nu_n').value, document.getElementById('nu_r').value
    );
  }
  function delUser(u) { if(confirm("Delete?")) google.script.run.withSuccessHandler(r=>{ loadUsers(); }).deleteUser(u); }

  function manageDd(act) {
    let cat = document.getElementById('dd_cat').value;
    let val = document.getElementById('dd_val').value;
    if(!val) return;
    showSpin(true);
    fetch(API_URL, {method:'POST', body:JSON.stringify({action:'manageData', subAction:act, category:cat, value:val})})
    .then(r=>r.json()).then(d=>{ showSpin(false); alert(d.message); if(d.result==='success') document.getElementById('dd_val').value=''; });
  }

  // HELPERS
  function fillSel(id, arr) { let e=document.getElementById(id); e.innerHTML='<option value="">Select...</option>'; arr.forEach(x=>e.innerHTML+=`<option>${x}</option>`); }
  function fillCheck(id, arr) { let e=document.getElementById(id); e.innerHTML=''; arr.forEach(x=>e.innerHTML+=`<div class="form-check"><input class="form-check-input" type="checkbox" value="${x}"><label class="form-check-label">${x}</label></div>`); }
  function logout() { location.reload(); }
</script>
</body>
</html>
