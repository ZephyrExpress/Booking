<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unified Logistics Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <link rel="icon" href="https://raw.githubusercontent.com/zephyrexpress/Booking/main/Icon.png">

  <style>
    :root { --primary-color: #2c3e50; --accent-color: #3498db; }
    body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; color: #343a40; overflow-x: hidden; }
    
    /* === MOBILE OPTIMIZED LOGIN === */
    .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 15px; }
    .login-card { width: 100%; max-width: 400px; padding: 2rem; background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .logo-login { max-width: 100%; height: auto; object-fit: contain; margin-bottom: 1.5rem; max-height: 70px; }
    
    /* === MAIN LAYOUT === */
    .main-container { max-width: 1400px; margin: 0 auto; padding: 15px; display: none; padding-bottom: 80px; }
    
    /* Mobile Header Tweaks */
    .header-bar { background: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .logo-header { height: 35px; width: auto; }
    
    /* Cards & Tabs */
    .card-custom { background: white; border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 20px; overflow: hidden; }
    .card-header-custom { background: #fff; border-bottom: 1px solid #f0f0f0; padding: 15px; font-weight: 700; color: var(--primary-color); display: flex; justify-content: space-between; align-items: center; }
    
    /* === RESPONSIVE TABLES === */
    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; } /* Smooth scroll on iOS */
    .table { white-space: nowrap; } /* Prevents ugly text wrapping on mobile */
    .table thead th { background-color: #f8f9fa; color: #6c757d; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid #dee2e6; }
    
    /* Mobile Form Fixes */
    input, select, textarea { font-size: 16px !important; } /* Prevents iOS zoom on focus */
    .form-control:focus, .form-select:focus { box-shadow: none; border-color: var(--accent-color); }
    
    /* Dropdown Pending State */
    .pending-state { border: 2px solid #dc3545 !important; color: #dc3545; background-color: #fff5f5; font-weight: 700; }
    
    /* Spinner */
    .spinner-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:none; justify-content:center; align-items:center; }
  </style>
</head>
<body>

<div id="spinner" class="spinner-overlay">
  <div class="text-center">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
  </div>
</div>

<div id="loginSection" class="login-wrapper">
  <div class="login-card">
    <div class="text-center">
      <img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" alt="Logo" class="logo-login">
    </div>
    <h5 class="text-center mb-4 fw-bold text-secondary">Portal Login</h5>
    
    <form onsubmit="event.preventDefault(); doLogin();">
      <div class="form-floating mb-3">
        <input type="text" class="form-control" id="uIn" placeholder="Username" required>
        <label>Username</label>
      </div>
      <div class="form-floating mb-4">
        <input type="password" class="form-control" id="pIn" placeholder="Password" required>
        <label>Password</label>
      </div>
      <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow-sm">
        LOG IN <i class="bi bi-box-arrow-in-right ms-2"></i>
      </button>
    </form>
    <div id="loginError" class="alert alert-danger mt-3 text-center small border-0 p-2" style="display:none;"></div>
  </div>
</div>

<div id="appSection" class="main-container">
  
  <div class="header-bar d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" alt="Logo" class="logo-header me-2">
      <div class="d-none d-md-block border-start ps-3 ms-2">
        <div class="fw-bold text-dark lh-1">Unified Portal</div>
        <small class="text-muted" style="font-size: 0.75rem;"><span id="userBadge">Guest</span></small>
      </div>
    </div>
    
    <div class="d-flex align-items-center gap-2">
      <span class="d-md-none badge bg-light text-dark border me-1" id="userBadgeMobile">User</span>
      <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3 fw-bold">
        <i class="bi bi-power"></i>
      </button>
    </div>
  </div>

  <div class="d-lg-none mb-3">
    <label class="small text-muted fw-bold ms-1 mb-1">NAVIGATE TO:</label>
    <select class="form-select fw-bold border-primary shadow-sm" onchange="mobileNav(this.value)">
      <option value="dash-content">üìä Dashboard</option>
      <option value="form-content">üì¶ Shipment Inbound</option>
      <option value="admin-content" id="mobileAdminOpt" style="display:none;">‚öôÔ∏è Admin Settings</option>
    </select>
  </div>

  <ul class="nav nav-pills mb-3 d-none d-lg-flex" id="topNav">
    <li class="nav-item me-2"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dash-content"><i class="bi bi-grid-1x2 me-2"></i>Dashboard</button></li>
    <li class="nav-item me-2"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#form-content"><i class="bi bi-box-seam me-2"></i>Inbound</button></li>
    <li class="nav-item" id="adminTabLi" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin-content"><i class="bi bi-gear me-2"></i>Admin</button></li>
  </ul>

  <div class="tab-content">
    
    <div class="tab-pane fade show active" id="dash-content">
      <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-dark btn-sm rounded-pill shadow-sm px-3" onclick="loadDashboard()">
          <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </button>
      </div>

      <div class="row g-3">
        
        <div class="col-12 col-xl-6">
          <div class="card-custom">
            <div class="card-header-custom">
              <span class="d-flex align-items-center"><i class="bi bi-robot me-2 text-primary"></i>Pending Automation</span>
              <span class="badge bg-danger rounded-pill" id="countAuto">0</span>
            </div>
            <div class="table-container p-0">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>AWB</th><th>Client</th><th>User</th>
                    <th style="min-width:160px">Assign To</th><th>Act</th>
                  </tr>
                </thead>
                <tbody id="tblAuto"></tbody>
              </table>
              <div id="noDataAuto" class="text-center py-4 text-muted small" style="display:none;">No pending tasks</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-xl-6">
          <div class="card-custom">
            <div class="card-header-custom">
              <span class="d-flex align-items-center"><i class="bi bi-truck me-2 text-warning"></i>Pending Shipments</span>
              <span class="badge bg-secondary rounded-pill" id="countAlloc">0</span>
            </div>
            <div class="table-container p-0">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Shipment Info</th>
                    <th>Net. No</th>
                    <th style="min-width:160px">Assign To</th><th>Act</th>
                  </tr>
                </thead>
                <tbody id="tblAlloc"></tbody>
              </table>
              <div id="noDataAlloc" class="text-center py-4 text-muted small" style="display:none;">No pending shipments</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="tab-pane fade" id="form-content">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
          <div class="card-custom p-3 p-md-4">
            <h5 class="text-primary fw-bold mb-3 border-bottom pb-2">New Inbound Entry</h5>
            <form id="shipForm">
              <div class="row g-3">
                <div class="col-12 col-md-4"><label class="small text-muted fw-bold">AWB NO.</label><input type="text" id="f_awb" class="form-control" required></div>
                <div class="col-6 col-md-4"><label class="small text-muted fw-bold">DATE</label><input type="date" id="f_date" class="form-control" required></div>
                <div class="col-6 col-md-4"><label class="small text-muted fw-bold">TYPE</label><select id="f_type" class="form-select"><option>Dox</option><option>Ndox</option></select></div>
                
                <div class="col-12 col-md-4"><label class="small text-muted fw-bold">NETWORK</label><select id="f_net" class="form-select"></select></div>
                <div class="col-12 col-md-4"><label class="small text-muted fw-bold">CLIENT</label><select id="f_client" placeholder="Search..."></select></div>
                <div class="col-12 col-md-4"><label class="small text-muted fw-bold">DESTINATION</label><select id="f_dest" placeholder="Search..."></select></div>
                
                <div class="col-6"><label class="small text-muted fw-bold">BOXES</label><input type="number" id="f_boxes" class="form-control" min="1" required></div>
                <div class="col-6"><label class="small text-muted fw-bold">CHG. WGT</label><input type="text" id="f_totalChg" class="form-control bg-light fw-bold text-primary" readonly value="0.00"></div>
              </div>

              <div class="mt-4 p-3 bg-light rounded border-0">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong class="text-secondary small">BOX DIMS</strong>
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="genBoxes()">+ Add Rows</button>
                </div>
                <div class="table-container">
                  <table class="table table-sm mb-0 bg-white">
                    <thead class="text-muted small"><tr><th>#</th><th>Wgt</th><th>L</th><th>B</th><th>H</th><th>Vol</th></tr></thead>
                    <tbody id="boxTable"></tbody>
                  </table>
                </div>
              </div>

              <div class="mt-3"><label class="small text-muted fw-bold">EXTRA CHARGES</label><div id="f_extra" class="d-flex flex-wrap gap-2 p-3 border rounded bg-white">Loading...</div></div>
              <div class="mt-3"><label class="small text-muted fw-bold">REMARKS</label><textarea id="f_remarks" class="form-control" rows="2"></textarea></div>
              <button type="submit" class="btn btn-primary w-100 mt-4 py-3 fw-bold rounded-pill shadow-sm">
                SUBMIT ENTRY <i class="bi bi-check-circle-fill ms-1"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="admin-content">
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card-custom p-3">
            <h6 class="fw-bold mb-3">üë§ Users</h6>
            <div class="input-group mb-3">
              <input type="text" id="nu_u" class="form-control form-control-sm" placeholder="User">
              <input type="text" id="nu_p" class="form-control form-control-sm" placeholder="Pass">
              <input type="text" id="nu_n" class="form-control form-control-sm" placeholder="Name">
              <select id="nu_r" class="form-select form-select-sm" style="max-width:70px"><option>Staff</option><option>Admin</option></select>
              <button class="btn btn-success btn-sm" onclick="addUser()">+</button>
            </div>
            <div style="max-height:300px; overflow-y:auto;">
              <table class="table table-sm table-striped mb-0"><tbody id="userTable"></tbody></table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card-custom p-3">
            <h6 class="fw-bold mb-3">üìù Dropdowns</h6>
            <select id="dd_cat" class="form-select mb-2">
              <option value="client">Client</option><option value="destination">Destination</option>
              <option value="network">Network</option><option value="extra">Extra Charges</option>
            </select>
            <div class="input-group">
              <input type="text" id="dd_val" class="form-control" placeholder="Value">
              <button class="btn btn-success" onclick="manageDd('add')">Add</button>
              <button class="btn btn-danger" onclick="manageDd('delete')">Del</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
  // ‚úÖ CONFIGURATION
  const API_URL = "https://script.google.com/macros/s/AKfycbwBjoV46m3wTuitwgaTGunQd9KvltP27be_oKn_6ZeSAwK7qna1B99AxtEu44QR_98EGQ/exec"; 

  let currentUser="", currentRole="", staffList=[];
  let tsClient, tsDest; 

  function showSpin(x) { document.getElementById('spinner').style.display = x ? 'flex' : 'none'; }

  // --- API HANDLER ---
  async function callApi(data) {
    showSpin(true);
    try {
      const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
      const result = await response.json();
      showSpin(false);
      return result;
    } catch (e) {
      showSpin(false);
      alert("Connection Error. Please check internet.");
      return { result: "error", message: "Failed" };
    }
  }
  
  async function fetchGet(action) {
    try {
      const response = await fetch(`${API_URL}?action=${action}&user=${currentUser}`);
      return await response.json();
    } catch (e) { return { result: "error" }; }
  }

  // --- LOGIN ---
  async function doLogin() {
    const u=document.getElementById('uIn').value, p=document.getElementById('pIn').value;
    if(!u || !p) return;
    const res = await callApi({ action: "login", username: u, password: p });
    if(res.result === "success") {
      currentUser = res.username; currentRole = res.role.toLowerCase();
      document.getElementById('userBadge').textContent = res.name;
      document.getElementById('userBadgeMobile').textContent = res.name;
      document.getElementById('loginSection').style.display='none';
      document.getElementById('appSection').style.display='block';
      if(currentRole==='admin') { 
        document.getElementById('adminTabLi').style.display='block'; 
        document.getElementById('mobileAdminOpt').style.display='block'; 
        loadUsers(); 
      }
      initApp();
    } else {
      document.getElementById('loginError').textContent = res.message;
      document.getElementById('loginError').style.display = 'block';
    }
  }

  // --- INIT ---
  async function initApp() {
    showSpin(true);
    document.getElementById('f_date').valueAsDate = new Date();
    const [staffRes, dropRes] = await Promise.all([fetchGet("getStaff"), fetchGet("getDropdowns")]);
    
    if(staffRes.result==="success") staffList = staffRes.list;
    if(dropRes.result==="success") {
      fillSel('f_net', dropRes.networks); fillSel('f_client', dropRes.clients); fillSel('f_dest', dropRes.destinations); fillCheck('f_extra', dropRes.extraCharges);
      tsClient=new TomSelect("#f_client",{create:false}); tsDest=new TomSelect("#f_dest",{create:false});
    }
    await loadDashboard(false); 
    showSpin(false);
  }

  // --- DASHBOARD RENDERER ---
  async function loadDashboard(showLoader=true) {
    if(showLoader) showSpin(true);
    const res = await fetchGet("getDashboardData"); 
    if(showLoader) showSpin(false);

    if(res.result === "success") {
      renderTable('tblAuto', 'noDataAuto', 'countAuto', res.automations, 'automation');
      renderTable('tblAlloc', 'noDataAlloc', 'countAlloc', res.allocations, 'allocation');
    }
  }

  function renderTable(tbodyId, noDataId, countId, data, type) {
    const tb = document.getElementById(tbodyId); tb.innerHTML='';
    document.getElementById(countId).textContent = data.length;
    document.getElementById(noDataId).style.display = data.length===0 ? 'block':'none';

    data.forEach(row => {
      let tr = document.createElement('tr');
      const addCell = (txt) => { let td=document.createElement('td'); td.innerHTML=txt; tr.appendChild(td); };
      
      if(type === 'automation') {
        // Automation: AWB(0), Client(1), Network(2), Boxes(3), User(4)
        addCell(`
          <div class="fw-bold text-primary">${row[0]}</div>
          <div class="small text-muted">${row[1]}</div>
        `);
        addCell(`<span class="badge bg-light text-dark border">${row[2]}</span>`);
        addCell(row[4]); 
      } else {
        // Alloc: AWB(0), Client(1), Network(2), NetNo(3), Weight(4), AutoBy(5)
        addCell(`
          <div class="fw-bold text-primary">${row[0]}</div>
          <div class="small text-muted">${row[1]} | ${row[2]}</div>
          <div class="small fw-bold">${row[4]} Kg <span class="fw-normal text-muted">(By: ${row[5]})</span></div>
        `);
        addCell(row[3]);
      }

      // ASSIGN DROPDOWN
      let tdSel = document.createElement('td');
      let sel = document.createElement('select'); 
      sel.className = "form-select form-select-sm pending-state"; // Default Red
      let defOpt = document.createElement('option'); defOpt.value=""; defOpt.text="PENDING"; sel.appendChild(defOpt);
      staffList.forEach(s => { let o=document.createElement('option'); o.value=s; o.text=s; sel.appendChild(o); });
      
      sel.onchange = function() {
        if(this.value) { this.classList.remove('pending-state'); this.classList.add('assigned-state'); }
        else { this.classList.remove('assigned-state'); this.classList.add('pending-state'); }
      };
      tdSel.appendChild(sel); tr.appendChild(tdSel);

      // BUTTON
      let tdBtn = document.createElement('td');
      let btn = document.createElement('button');
      btn.className="btn btn-success btn-sm w-100 fw-bold"; 
      btn.innerHTML='<i class="bi bi-check2"></i>';
      btn.onclick = async () => {
        if(!sel.value) return alert("Select staff first");
        btn.innerHTML='...'; btn.disabled=true;
        const apiRes = await callApi({ action: "assignTask", type: type, id: row[0], staff: sel.value, assigner: currentUser });
        if(apiRes.result==="success") { tr.remove(); let c=document.getElementById(countId); c.textContent=Math.max(0, parseInt(c.textContent)-1); }
        else { alert(apiRes.message); btn.disabled=false; btn.innerHTML='<i class="bi bi-check2"></i>'; }
      };
      tdBtn.appendChild(btn); tr.appendChild(tdBtn);
      tb.appendChild(tr);
    });
  }

  // --- FORM LOGIC ---
  function genBoxes() {
    let n = document.getElementById('f_boxes').value, tb = document.getElementById('boxTable'); tb.innerHTML='';
    for(let i=1; i<=n; i++) tb.innerHTML += `<tr><td>${i}</td><td><input type="number" class="form-control form-control-sm" oninput="calcBox(this)"></td><td><input type="number" class="form-control form-control-sm" oninput="calcBox(this)"></td><td><input type="number" class="form-control form-control-sm" oninput="calcBox(this)"></td><td><input type="number" class="form-control form-control-sm" oninput="calcBox(this)"></td><td class="text-primary fw-bold small chg-val">0.00</td></tr>`;
  }
  function calcBox(el) {
    let tr=el.closest('tr'), inps=tr.querySelectorAll('input'), w=parseFloat(inps[0].value)||0, l=parseFloat(inps[1].value)||0, b=parseFloat(inps[2].value)||0, h=parseFloat(inps[3].value)||0;
    let chg = Math.max(w, (l*b*h)/5000).toFixed(2); tr.querySelector('.chg-val').textContent = chg;
    let tot=0; document.querySelectorAll('.chg-val').forEach(e => tot+=parseFloat(e.textContent)); document.getElementById('f_totalChg').value=tot.toFixed(2);
  }
  document.getElementById('shipForm').onsubmit = async (e) => {
    e.preventDefault();
    let boxes=[], extra=[]; document.querySelectorAll('#boxTable tr').forEach((tr,i)=>{ let inps=tr.querySelectorAll('input'); if(inps.length) boxes.push({no:i+1, weight:inps[0].value, length:inps[1].value, breath:inps[2].value, height:inps[3].value}); });
    document.querySelectorAll('#f_extra input:checked').forEach(c=>extra.push(c.value));
    const res = await callApi({ action: 'submit', username: currentUser, awb: document.getElementById('f_awb').value, date: document.getElementById('f_date').value, type: document.getElementById('f_type').value, network: document.getElementById('f_net').value, client: document.getElementById('f_client').value, destination: document.getElementById('f_dest').value, totalBoxes: document.getElementById('f_boxes').value, extraCharges: extra.join(', '), extraRemarks: document.getElementById('f_remarks').value, boxes: boxes });
    if(res.result==='success') { alert("‚úÖ Inbound Saved!"); document.getElementById('shipForm').reset(); document.getElementById('boxTable').innerHTML=''; tsClient.clear(); tsDest.clear(); } else alert("‚ùå "+res.message);
  };

  // --- ADMIN ---
  async function loadUsers() { const r=await fetchGet("getUsers"); if(r.result==="success") { let t=document.getElementById('userTable'); t.innerHTML=''; r.users.forEach(u=>t.innerHTML+=`<tr><td>${u[0]}</td><td>${u[1]}</td><td>${u[2]}</td><td>${u[3]}</td><td><button class="btn btn-danger btn-sm py-0" onclick="delUser('${u[0]}')">X</button></td></tr>`); } }
  async function addUser() { const r=await callApi({action:"addUser", u:document.getElementById('nu_u').value, p:document.getElementById('nu_p').value, n:document.getElementById('nu_n').value, r:document.getElementById('nu_r').value}); alert(r.message); if(r.result==="success") loadUsers(); }
  async function delUser(u) { if(confirm("Delete user?")) { await callApi({action:"deleteUser", username:u}); loadUsers(); } }
  async function manageDd(act) { const v=document.getElementById('dd_val').value; if(!v) return; const r=await callApi({action:'manageData', subAction:act, category:document.getElementById('dd_cat').value, value:v}); alert(r.message); if(r.result==='success') { document.getElementById('dd_val').value=''; initApp(); } }
  
  function mobileNav(tabId) { 
    // Hides all tabs and shows the selected one manually to support the dropdown
    document.querySelectorAll('.tab-pane').forEach(el => { el.classList.remove('show', 'active'); });
    document.getElementById(tabId).classList.add('show', 'active');
  }
  function fillSel(id, arr) { let e=document.getElementById(id); e.innerHTML='<option value="">Select...</option>'; arr.forEach(x=>e.innerHTML+=`<option value="${x}">${x}</option>`); }
  function fillCheck(id, arr) { let e=document.getElementById(id); e.innerHTML=''; arr.forEach(x=>e.innerHTML+=`<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="${x}"><label class="form-check-label small">${x}</label></div>`); }
  function logout() { location.reload(); }
</script>
</body>
</html>
