<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zephyr Express Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="https://raw.githubusercontent.com/zephyrexpress/Booking/main/Icon.png">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js" defer></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" defer></script>

  <style>
    :root {
      --sidebar-width: 260px;
      --header-height: 64px;
      /* Brand Colors */
      --brand-blue: #003399;
      --brand-red: #d40511;
      --brand-yellow: #ffcc00;

      --primary-color: var(--brand-blue);
      --secondary-color: #334155;
      --bg-color: #f8fafc;
      --border-color: #e2e8f0;
      --font-main: 'Inter', sans-serif;
    }
    body { background-color: var(--bg-color); font-family: var(--font-main); color: var(--secondary-color); margin: 0; padding: 0; width: 100%; position: relative; overflow-x: hidden; }

    /* Login - Centered Card */
    .login-wrapper {
        min-height: 100vh; display: flex; align-items: center; justify-content: center;
        background-color: #f0f4f8;
        /* Custom SVG Pattern: Planes and Boxes */
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23003399' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3Cpath d='M28.5 18L24 24h9l-4.5-6zm-17 30l-4.5 6h9l-4.5-6zm34 0l-4.5 6h9l-4.5-6z' fill='%23d40511' fill-opacity='0.05'/%3E%3C/g%3E%3C/svg%3E");
        position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
        display: flex; align-items: center; justify-content: center;
    }
    .login-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0, 51, 153, 0.7); z-index: 1; }
    /* Global Mobile Fixes */
    img { max-width: 100%; height: auto; }
    .login-card {
        width: 90%; max-width: 400px; padding: 2.5rem; background: #ffffff; border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.5); z-index: 2; position: relative; text-align: center;
        border: 1px solid rgba(0,0,0,0.1);
    }
    .login-card img { max-width: 80%; height: auto; display: inline-block; }

    /* ULTRA MOBILE OPTIMIZATIONS (Kakarot Mode) */
    @media (max-width: 768px) {
        /* Unlock body scroll, let content flow */
        body, html { overflow-x: auto; width: 100%; }

        /* Containers */
        .main-container { padding: 0.5rem !important; width: 100%; box-sizing: border-box; }
        .panel-card, .stat-card { width: 100%; margin-bottom: 1rem; border-radius: 8px; }

        /* Stacking Headers */
        .panel-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; padding: 0.75rem; }
        .panel-header button, .panel-header select { width: 100%; margin-top: 0.5rem; }

        /* Topbar Stacking */
        .topbar { height: auto; padding: 0.75rem; flex-direction: column; gap: 0.5rem; align-items: flex-start; }
        .topbar .d-flex { width: 100%; justify-content: space-between; }

        /* Typography Reduction */
        h4, h5 { font-size: 1rem !important; }
        .stat-value { font-size: 1.25rem; }
        .stat-label { font-size: 0.65rem; }
        th, td { font-size: 0.75rem !important; padding: 0.4rem !important; }

        /* Input Constraints */
        .fun-input, .form-select, .form-control, .input-group { width: 100% !important; max-width: 100% !important; }

        /* Grid Fixes */
        .row { margin: 0; width: 100%; }
        .col-md-3, .col-lg-6, .col-md-4, .col-md-5, .col-md-2, .col-12 { padding-left: 0; padding-right: 0; }

        /* Login Fixes */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 1rem; align-items: flex-start; padding-top: 10vh; z-index: 2000; }
        .login-card { width: 100%; padding: 1.5rem; margin-bottom: 2rem; }

        /* Scrollable Tables */
        .table-responsive { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem; border: 1px solid #eee; }

        /* Hide non-critical on mobile if needed */
        .d-none-mobile { display: none !important; }
    }

    /* Layout */
    .sidebar { width: var(--sidebar-width); background-color: var(--brand-blue); position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000; transition: transform 0.3s; transform: translateX(-100%); color: white; display:flex; flex-direction:column; box-shadow: 4px 0 24px rgba(0,0,0,0.1); }
    @media (min-width: 992px) { .sidebar { transform: translateX(-100%); } .sidebar.show { transform: translateX(0); } } /* Default hidden on all */
    .sidebar.show { transform: translateX(0); }
    .sidebar-brand { height: var(--header-height); padding: 0 1.5rem; display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 800; color: white; letter-spacing: 1px; font-size: 1.2rem; }
    .sidebar-nav { flex: 1; padding: 1.5rem 1rem; overflow-y: auto; }
    .content-area { flex: 1; transition: margin 0.3s; min-height: 100vh; display:flex; flex-direction: column; }
    .topbar { height: var(--header-height); background: white; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; position: sticky; top: 0; z-index: 990; }
    
    .nav-item-custom { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 8px; color: rgba(255,255,255,0.7); text-decoration: none; margin-bottom: 4px; cursor:pointer; font-weight: 500; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; transition: all 0.2s; }
    .nav-item-custom:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-item-custom.active { background: var(--brand-red); color: white; box-shadow: 0 4px 12px rgba(212, 5, 17, 0.3); }
    .nav-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin: 1.5rem 0 0.5rem 0.75rem; color: var(--brand-yellow); letter-spacing: 1px; opacity: 0.8; }
    
    .panel-card { background: white; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05); height: 100%; overflow: hidden; }
    /* Global Uppercase for Headings */
    h1, h2, h3, h4, h5, h6, .panel-header, .modal-title, .fun-header, .stat-label, .nav-label, th { text-transform: uppercase !important; letter-spacing: 0.5px; }
    .panel-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); font-weight: 700; background: #fdfdfd; display:flex; justify-content:space-between; align-items:center; }

    .stat-card { background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); display: flex; justify-content: space-between; }
    .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-color); }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1060; }
    .spinner-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:none; justify-content:center; align-items:center; }
    .mobile-toggle { display: block !important; background:none; border:none; font-size:1.5rem; color:var(--primary-color); }
    .sidebar-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
    .sidebar-backdrop.show { display: block; }

    /* FUN & COLOURFUL INPUTS */
    .fun-input { border: 2px solid #e2e8f0; transition: all 0.2s; }
    .fun-input:focus { border-color: var(--brand-blue); box-shadow: 0 0 0 4px rgba(0, 51, 153, 0.1); }
    .fun-header { background: linear-gradient(135deg, var(--brand-blue) 0%, #002266 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; }
    .fun-header h5, .modal-title { text-transform: uppercase; letter-spacing: 1px; }
    .fun-label { color: #475569; font-weight: 600; font-size: 0.85rem; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .fun-section { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .fun-section-green { background: #f0fdf4; border-color: #bbf7d0; }
    
    /* Dark Checkboxes */
    .form-check-input { border-color: #64748b; border-width: 2px; }
    .form-check-input:checked { background-color: var(--brand-blue); border-color: var(--brand-blue); }

    /* Tables */
    .overview-table th, .excel-table th { background-color: #f1f5f9; font-size: 0.75rem; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; border: 1px solid #e2e8f0; padding: 0.75rem; }
    .overview-table td, .excel-table td { border: 1px solid #e2e8f0; font-size: 0.85rem; padding: 0.75rem; vertical-align: middle; }
    .sticky-top { z-index: 10; }
    .clickable-cell { cursor: pointer; color: var(--brand-blue); font-weight: 600; text-decoration: underline; }
    .clickable-cell:hover { color: var(--brand-red); }

    /* Fix TomSelect Dropdown Z-Index inside Modals */
    .ts-dropdown, .ts-wrapper.single.input-active .ts-control { z-index: 10000 !important; }

    /* Brand Button Overrides */
    .btn-primary { background-color: var(--brand-blue) !important; border-color: var(--brand-blue) !important; color: white !important; }
    .btn-danger { background-color: var(--brand-red) !important; border-color: var(--brand-red) !important; color: white !important; }
    .btn-warning { background-color: var(--brand-yellow) !important; border-color: var(--brand-yellow) !important; color: black !important; }
    .btn-success { background-color: #198754 !important; border-color: #198754 !important; color: white !important; }

    /* Stacked List Item Style for Overview */
    .list-item-stacked { border-bottom: 1px solid #e2e8f0; padding: 1rem; transition: background 0.2s; }
    .list-item-stacked:hover { background: #f8fafc; }
    .list-item-stacked:last-child { border-bottom: none; }
    .list-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
    .list-row.last { margin-bottom: 0; }
    .list-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; font-weight: 600; margin-right: 0.5rem; }
    .list-val { font-size: 0.9rem; font-weight: 500; color: #1e293b; }
    .list-val-bold { font-weight: 700; color: var(--brand-blue); font-family: monospace; font-size: 1rem; }
  </style>
</head>
<body>

<div id="spinner" class="spinner-overlay"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div></div>
<div class="toast-container" id="toastContainer"></div>

<!-- LOGIN -->
<div id="loginSection" class="login-wrapper">
  <div class="login-overlay"></div>
  <div class="login-card">
    <div class="text-center mb-4"><img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" height="60" class="d-block mx-auto"></div>
    <p class="text-center text-muted small mb-4">PORTAL LOGIN v5.2</p>
    <form onsubmit="event.preventDefault(); doLogin();">
      <input type="text" id="uIn" class="form-control mb-3 p-3" placeholder="Username" required>
      <input type="text" id="pIn" class="form-control mb-4 p-3" placeholder="Password" style="-webkit-text-security:disc" required>
      <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm" style="background-color: var(--brand-blue); border:none;">SIGN IN</button>
    </form>
    <div id="loginError" class="alert alert-danger mt-3 small text-center" style="display:none;"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="appSection" class="main-wrapper" style="display:none;">
  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" height="30" class="me-2" style="filter: brightness(0) invert(1);">
    </div>
    <div class="sidebar-nav">
      <div class="nav-label">Main Menu</div>
      <a class="nav-item-custom" id="nav-inbound" onclick="switchTab('inbound')" style="display:none"><i class="bi bi-box-seam me-2"></i> Inbound</a>
      <a class="nav-item-custom active" id="nav-overview" onclick="switchTab('overview')" style="display:none"><i class="bi bi-grid-1x2 me-2"></i> Overview</a>
      <a class="nav-item-custom" id="nav-holdings" onclick="switchTab('holdings')" style="display:none"><i class="bi bi-pause-circle me-2"></i> Holdings</a>
      <a class="nav-item-custom" id="nav-taskhub" onclick="switchTab('taskhub')" style="display:none"><i class="bi bi-check-circle me-2"></i> <span id="taskLabel">My Tasks</span></a>
      <a class="nav-item-custom" id="nav-manifest" onclick="switchTab('manifest')" style="display:none"><i class="bi bi-file-earmark-spreadsheet me-2"></i> Manifest</a>
      <a class="nav-item-custom" id="nav-receivers" onclick="switchTab('receivers')" style="display:none"><i class="bi bi-printer me-2"></i> Receivers Copy</a>
      
      <div id="adminNavGroup" style="display:none;">
        <div class="nav-label">Administration</div>
        <a class="nav-item-custom" id="nav-admin" onclick="switchTab('admin')"><i class="bi bi-shield-lock me-2"></i> Admin Panel <span id="adminBadge" class="badge bg-danger ms-auto" style="display:none">0</span></a>
      </div>
    </div>
    <div class="sidebar-footer border-top border-white border-opacity-10 p-3">
       <div class="d-flex align-items-center text-white">
          <div class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center me-2" style="width:32px;height:32px"><i class="bi bi-person-fill"></i></div>
          <div style="flex:1; overflow:hidden;"><div id="userDisplay" class="fw-bold small text-truncate">User</div></div>
          <button onclick="logout()" class="btn btn-link text-white p-0 opacity-75" title="Logout"><i class="bi bi-box-arrow-right"></i></button>
       </div>
    </div>
  </aside>

  <main class="content-area">
    <div class="topbar">
      <div class="d-flex align-items-center">
        <button class="mobile-toggle me-3" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
        <h5 class="m-0 fw-bold text-primary" id="pageTitle">Overview</h5>
      </div>
      <div class="d-flex align-items-center gap-3">
         <div class="text-end d-none d-md-block">
            <div class="small fw-bold text-muted" id="dateDisplay"></div>
            <div class="small fw-bold text-muted" id="timeDisplay"></div>
         </div>
         <button class="btn btn-light border text-primary fw-bold btn-sm shadow-sm" onclick="refreshApp()" title="Refresh Data"><i class="bi bi-arrow-clockwise me-1"></i> Refresh</button>
      </div>
    </div>

    <div class="main-container p-4">
      
      <!-- INBOUND TAB -->
      <div id="inbound-tab" class="tab-view" style="display:none;">
         <div class="panel-card mx-auto shadow-sm" style="max-width:1100px; border:none;">
           <div class="fun-header">
              <h5 class="fw-bold m-0"><i class="bi bi-plus-circle-fill me-2"></i>New Shipment Entry</h5>
              <div class="small opacity-75">Please fill all details accurately</div>
           </div>
           <div class="p-4">
             <form id="shipForm">
               <div class="row g-4 mb-4">
                 <div class="col-md-4">
                    <label class="fun-label">Airway Bill Number *</label>
                    <div class="input-group">
                        <input id="f_awb" class="form-control fun-input font-monospace" required placeholder="000-00000000">
                        <button class="btn btn-warning" id="btnAutoAwb" type="button" onclick="generateAwb()" title="Auto Generate"><i class="bi bi-magic"></i></button>
                        <button class="btn btn-dark" type="button" onclick="startScanner('f_awb')" title="Scan Barcode"><i class="bi bi-qr-code-scan"></i></button>
                    </div>
                 </div>
                 <div class="col-md-4"><label class="fun-label">Date *</label><input type="date" id="f_date" class="form-control fun-input" required></div>
                 <div class="col-md-4"><label class="fun-label">Shipment Content *</label>
                    <select id="f_type" class="form-select fun-input" onchange="chkDox()" required><option value="" selected disabled>Select...</option><option>Dox</option><option>Ndox</option></select>
                 </div>
                 <div class="col-md-4"><label class="fun-label">Network *</label>
                    <select id="f_net" class="form-select fun-input" required><option value="" selected disabled>Select...</option></select>
                 </div>
                 <div class="col-md-4"><label class="fun-label">Client *</label><select id="f_client" required></select></div>
                 <div class="col-md-4"><label class="fun-label">Destination *</label><select id="f_dest" required></select></div>
               </div>

               <div class="mb-4 p-3 border rounded bg-white">
                  <label class="fun-label d-block mb-2">Shipment Type *</label>
                  <div class="d-flex gap-4">
                      <div class="form-check"><input class="form-check-input" type="checkbox" name="stype" value="Regular" id="st_reg" onchange="chkStype(this)" checked><label class="form-check-label fw-bold" for="st_reg">Regular</label></div>
                      <div class="form-check"><input class="form-check-input" type="checkbox" name="stype" value="CBV 5" id="st_cbv" onchange="chkStype(this)"><label class="form-check-label fw-bold" for="st_cbv">CBV 5</label></div>
                      <div class="form-check"><input class="form-check-input" type="checkbox" name="stype" value="Commercial" id="st_com" onchange="chkStype(this)"><label class="form-check-label fw-bold" for="st_com">Commercial</label></div>
                  </div>
               </div>

               <div class="fun-section fun-section-green">
                  <h6 class="fw-bold text-success mb-3"><i class="bi bi-box-seam me-2"></i>Package Details</h6>
                  <div class="row g-3 align-items-end mb-3">
                     <div class="col-md-4"><label class="fun-label">Total No. of Boxes *</label><div class="input-group"><input type="number" id="f_boxes" class="form-control fun-input" required placeholder=""><button type="button" class="btn btn-success" onclick="genBoxes()">Generate</button></div></div>
                     <div class="col-md-4"><label class="fun-label">Total Chargeable Weight</label><input id="f_totalChg" class="form-control fun-input bg-success bg-opacity-10 fw-bold text-success" readonly value="0.00"></div>
                  </div>
                  <div class="table-responsive bg-white rounded border">
                      <table class="table table-sm mb-0 align-middle">
                          <thead class="table-light"><tr><th>#</th><th>Weight (Kg) *</th><th>L (cm)</th><th>W (cm)</th><th>H (cm)</th><th>Chg Wgt</th></tr></thead>
                          <tbody id="boxTable"></tbody>
                      </table>
                  </div>
               </div>

               <div class="fun-section border-warning">
                  <h6 class="fw-bold text-warning mb-3"><i class="bi bi-currency-rupee me-2"></i>Payment Details</h6>
                  <div class="row g-3">
                     <div class="col-md-4"><label class="fun-label">Total Amount</label><input type="number" step="0.01" id="f_payTotal" class="form-control fun-input" oninput="cPay()"></div>
                     <div class="col-md-4"><label class="fun-label">Amount Paid</label><input type="number" step="0.01" id="f_payPaid" class="form-control fun-input" oninput="cPay()"></div>
                     <div class="col-md-4"><label class="fun-label">Pending Amount</label><input type="number" step="0.01" id="f_payPending" class="form-control fun-input bg-warning bg-opacity-10 fw-bold" readonly value="0"></div>
                  </div>
               </div>

               <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                      <label class="fun-label m-0">Required Paperwork *</label>
                      <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" onchange="toggleAllPaperwork(this)"><label class="form-check-label small fw-bold">Select All</label></div>
                  </div>
                  <div id="f_paperwork" class="d-flex flex-wrap gap-2 p-3 bg-white rounded border">
                     <div class="form-check"><input class="form-check-input pw-chk" type="checkbox" value="KYC"><label class="form-check-label small">KYC</label></div>
                     <div class="form-check"><input class="form-check-input pw-chk" type="checkbox" value="INVOICE"><label class="form-check-label small">INVOICE</label></div>
                     <div class="form-check"><input class="form-check-input pw-chk" type="checkbox" value="LOA"><label class="form-check-label small">LOA</label></div>
                     <div class="form-check"><input class="form-check-input pw-chk" type="checkbox" value="N/A"><label class="form-check-label small">N/A</label></div>
                  </div>
               </div>

               <div class="mb-3"><label class="fun-label">Extra Charges</label><div id="f_extra" class="d-flex flex-wrap gap-2 p-3 bg-white rounded border"></div></div>
               <div class="mb-4"><label class="fun-label">Extra Charges Remarks (if applicable)</label><textarea id="f_remarks" class="form-control fun-input" rows="2"></textarea></div>

               <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                 <button type="button" class="btn btn-light rounded-pill px-4" onclick="resetForm()">Reset</button>
                 <button class="btn btn-primary px-5 rounded-pill fw-bold py-2 shadow-sm">Submit Entry</button>
               </div>
             </form>
           </div>
         </div>
      </div>

      <!-- OVERVIEW TAB -->
      <div id="overview-tab" class="tab-view">
        <div class="row g-4 mb-4">
           <div class="col-md-3"><div class="stat-card"><div><div class="stat-label">TODAY'S INBOUND</div><div class="stat-value text-success" id="ovInbound">0</div></div><i class="bi bi-calendar-check fs-1 text-success opacity-25"></i></div></div>
           <div class="col-md-3"><div class="stat-card"><div><div class="stat-label">PENDING AUTOMATION</div><div class="stat-value text-danger" id="ovAuto">0</div></div><i class="bi bi-robot fs-1 text-danger opacity-25"></i></div></div>
           <div class="col-md-3"><div class="stat-card"><div><div class="stat-label">PENDING PAPERWORK</div><div class="stat-value text-warning" id="ovPaper">0</div></div><i class="bi bi-files fs-1 text-warning opacity-25"></i></div></div>
           <div class="col-md-3"><div class="stat-card"><div><div class="stat-label">TOTAL HOLDINGS</div><div class="stat-value text-secondary" id="ovHoldings">0</div></div><i class="bi bi-pause-circle fs-1 text-secondary opacity-25"></i></div></div>
        </div>

        <div class="row g-4">
          <div class="col-lg-6">
            <div class="panel-card" style="height:600px">
              <div class="panel-header bg-danger bg-opacity-10 text-danger border-danger border-opacity-25">
                 <span><i class="bi bi-hourglass-split me-2"></i>Pending Automation <span class="badge bg-danger ms-2" id="badgeAuto">0</span></span>
                 <button class="btn btn-sm btn-outline-danger bg-white" onclick="exportOverview('auto')">Export</button>
              </div>
              <div class="panel-body p-0" style="height:540px; overflow-y: auto;">
                 <div id="listAuto" class="list-group list-group-flush"></div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="panel-card" style="height:600px">
              <div class="panel-header bg-warning bg-opacity-10 text-dark border-warning border-opacity-25">
                 <span><i class="bi bi-clock-history me-2"></i>Pending Paperwork <span class="badge bg-warning text-dark ms-2" id="badgePaper">0</span></span>
                 <button class="btn btn-sm btn-outline-warning bg-white text-dark" onclick="exportOverview('paper')">Export</button>
              </div>
              <div class="panel-body p-0" style="height:540px; overflow-y: auto;">
                 <div id="listPaper" class="list-group list-group-flush"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- HOLDINGS TAB -->
      <div id="holdings-tab" class="tab-view" style="display:none;">
         <div class="bg-white p-4 rounded-4 shadow-sm border mb-4">
             <div class="d-flex justify-content-between align-items-center mb-4">
                 <div>
                     <h4 class="fw-bold text-dark m-0"><i class="bi bi-pause-circle-fill text-danger me-2"></i>Holdings Manager</h4>
                     <p class="text-muted small m-0">Search shipments to Manage or Release Holds</p>
                 </div>
                 <div class="text-end">
                     <span class="d-block small fw-bold text-muted text-uppercase ls-1">Total On Hold</span>
                     <span class="fs-2 fw-800 text-danger" id="totalHoldings">0</span>
                 </div>
             </div>

             <div class="row g-3">
                 <div class="col-md-5">
                     <div class="input-group input-group-lg">
                         <button class="btn btn-dark" onclick="startScanner('holdSearchAwb')" title="Scan"><i class="bi bi-qr-code-scan"></i></button>
                         <input id="holdSearchAwb" class="form-control border-start-0" placeholder="Scan or Enter AWB Number..." oninput="searchHoldings()">
                     </div>
                 </div>
                 <div class="col-md-5">
                     <div class="input-group input-group-lg">
                         <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-globe"></i></span>
                         <input id="holdSearchNet" class="form-control border-start-0" placeholder="Search by Network No..." oninput="searchHoldings()">
                     </div>
                 </div>
                 <div class="col-md-2">
                     <button class="btn btn-light btn-lg w-100 border fw-bold text-muted" onclick="clearHoldSearch()">Clear</button>
                 </div>
             </div>
         </div>

         <!-- SEARCH RESULT CARD -->
         <div id="holdResultPanel" class="mb-4" style="display:none;"></div>

         <!-- ACTIVE HOLDINGS TABLE -->
         <div class="panel-card">
             <div class="panel-header">
                 <span class="fw-bold text-danger">Active Holdings List</span>
             </div>
             <div class="table-responsive">
                 <table class="table overview-table align-middle mb-0">
                     <thead class="bg-light">
                         <tr>
                             <th>AWB</th><th>Network No</th><th>Client</th><th>Reason</th><th>Remarks</th><th>Held By</th>
                         </tr>
                     </thead>
                     <tbody id="holdingsList"></tbody>
                 </table>
             </div>
         </div>
      </div>

      <!-- TASK HUB TAB -->
      <div id="taskhub-tab" class="tab-view" style="display:none;">
        <div id="adminTaskView" style="display:none">
           <div class="panel-card">
              <div class="panel-header bg-primary text-white"><span><i class="bi bi-kanban me-2"></i>Task Manager (Global Pool)</span> <button class="btn btn-sm btn-light text-primary fw-bold" onclick="exportPool()">Export</button></div>
              <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0 excel-table">
                      <thead class="bg-light"><tr><th>AWB</th><th>Net No</th><th>Network</th><th>Weight</th><th>Details</th><th>Client</th><th class="text-center">Assigned To</th><th>Action</th></tr></thead>
                      <tbody id="poolBody"></tbody>
                  </table>
              </div>
           </div>
        </div>
        <div id="staffTaskView" style="display:none">
             <div class="row g-4">
                 <div class="col-lg-6">
                     <div class="alert alert-info py-3 shadow-sm border-0 border-start border-4 border-info"><h5 class="alert-heading fw-bold m-0"><i class="bi bi-robot me-2"></i>My Automated Shipments</h5></div>
                     <div id="contAssign" class="row g-3"></div>
                 </div>
                 <div class="col-lg-6">
                     <div class="alert alert-warning py-3 shadow-sm border-0 border-start border-4 border-warning"><h5 class="alert-heading fw-bold m-0"><i class="bi bi-list-check me-2"></i>My To-Do List</h5></div>
                     <div id="contTodo" class="row g-3"></div>
                 </div>
             </div>
        </div>
      </div>

      <!-- MANIFEST TAB -->
      <div id="manifest-tab" class="tab-view" style="display:none;">
        <ul class="nav nav-pills mb-3" id="manTabs">
           <li class="nav-item"><button class="nav-link active rounded-pill px-4" onclick="switchManifestView('pending')">Pending Manifest</button></li>
           <li class="nav-item ms-2"><button class="nav-link rounded-pill px-4" onclick="switchManifestView('history')">Manifest History</button></li>
        </ul>
        <div id="man-pending-view">
          <div class="panel-card">
             <div class="panel-header">
                <div class="d-flex align-items-center gap-3">
                   <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="bi bi-file-earmark-spreadsheet"></i></div>
                   <div><div class="fw-bold">Ready to Manifest</div><div class="small text-muted fw-normal">Items with Paperwork Completed</div></div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                   <select id="man_net" class="form-select" onchange="renderManifest()"><option value="">Select Network...</option></select>
                   <button class="btn btn-primary rounded-pill shadow-sm text-nowrap" onclick="createBatch()"><i class="bi bi-collection me-2"></i>Generate Batch</button>
                </div>
             </div>
             <div class="panel-body p-0">
                <div class="table-responsive">
                   <table class="table table-hover align-middle mb-0">
                      <thead class="bg-light">
                         <tr>
                            <th class="ps-4" style="width:40px"><input type="checkbox" class="form-check-input" id="checkAllMan" onclick="toggleAllMan(this)"></th>
                            <th>AWB</th><th>Date</th><th>Destination</th><th>Network</th><th>Net No</th><th>Pcs</th><th>Wgt</th><th>Client</th><th class="text-end pe-4">Status</th>
                         </tr>
                      </thead>
                      <tbody id="manifestList"></tbody>
                   </table>
                </div>
                <div id="manifestEmptyState" class="text-center py-5">
                   <div class="mb-3 text-muted"><i class="bi bi-inbox fs-1"></i></div>
                   <h6 class="text-muted fw-bold">No Items Ready</h6>
                   <p class="text-muted small">Select a network to view items.</p>
                </div>
             </div>
          </div>
        </div>
        <div id="man-history-view" style="display:none;">
           <div class="row g-4" id="batchContainer"></div>
           <div id="batchEmptyState" class="text-center py-5" style="display:none"><div class="mb-3 text-muted"><i class="bi bi-clock-history fs-1"></i></div><h6 class="text-muted fw-bold">No History</h6><p class="text-muted small">Generated batches appear here.</p></div>
        </div>
      </div>

      <!-- RECEIVERS COPY TAB -->
      <div id="receivers-tab" class="tab-view" style="display:none;">
         <div class="panel-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
               <h5 class="m-0 fw-bold text-primary"><i class="bi bi-printer me-2"></i>Receivers Copy Manager</h5>
               <div class="d-flex gap-2">
                   <button class="btn btn-outline-secondary rounded-pill shadow-sm" onclick="renderReceivers()"><i class="bi bi-arrow-clockwise me-2"></i>Refresh List</button>
                   <button class="btn btn-success rounded-pill shadow-sm" onclick="exportReceiverExcel()"><i class="bi bi-file-earmark-excel me-2"></i>Export Excel</button>
               </div>
            </div>
            <div class="table-responsive border rounded" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-hover align-middle mb-0 small">
                    <thead class="bg-light sticky-top"><tr><th style="width:40px"><input type="checkbox" onchange="toggleRc(this)"></th><th>AWB</th><th>Date</th><th>Client</th><th>Dest</th><th>Wgt</th><th>Status</th><th class="text-end">Action</th></tr></thead>
                    <tbody id="rcList"></tbody>
                </table>
            </div>
         </div>
      </div>

      <!-- ADMIN TAB (UPDATED) -->
      <div id="admin-tab" class="tab-view" style="display:none;">
         <div class="row g-4">
            <div class="col-12">
               <div class="panel-card p-4">
                  <h5 class="fw-bold text-primary mb-3">User & Permission Management</h5>
                  <div class="alert alert-light border small text-muted"><i class="bi bi-info-circle me-2"></i>Owners can promote/demote. Admins can manage data. Staff access is restricted by permissions.</div>

                  <!-- Auto AWB Toggle -->
                  <div class="d-flex align-items-center justify-content-between p-3 border rounded mb-4 bg-light">
                      <div class="fw-bold text-dark"><i class="bi bi-magic me-2"></i>Auto AWB Generation</div>
                      <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" role="switch" id="autoAwbSwitch" onchange="toggleAutoAwb(this)">
                          <label class="form-check-label small fw-bold" id="autoAwbLabel">Enabled</label>
                      </div>
                  </div>

                  <!-- Add User -->
                  <div class="input-group mb-4">
                      <input id="nu_u" class="form-control" placeholder="New Username">
                      <input id="nu_p" class="form-control" placeholder="Password">
                      <input id="nu_n" class="form-control" placeholder="Full Name">
                      <select id="nu_r" class="form-select" style="max-width:120px"><option>Staff</option><option>Admin</option></select>
                      <button class="btn btn-success" onclick="addUser()">Add User</button>
                  </div>

                  <!-- User Table -->
                  <div class="table-responsive border rounded">
                      <table class="table table-hover align-middle mb-0">
                          <thead class="bg-light"><tr><th>User</th><th>Pass</th><th>Name</th><th>Role</th><th>Permissions (Staff Only)</th><th>Actions</th></tr></thead>
                          <tbody id="userList"></tbody>
                      </table>
                  </div>
               </div>
            </div>

            <div class="col-md-6">
               <div class="panel-card p-3 h-100">
                  <h6 class="fw-bold text-warning mb-3">Transfer Requests</h6>
                  <div id="reqList" class="list-group list-group-flush"></div>
               </div>
            </div>
            <div class="col-md-6">
               <div class="panel-card p-3 h-100">
                  <h6 class="fw-bold text-success mb-3">Dropdown Manager</h6>
                  <div class="d-flex gap-2 mb-3">
                      <select id="dd_cat" class="form-select" onchange="updDd()">
                          <option value="network">Network</option>
                          <option value="client">Client</option>
                          <option value="destination">Dest</option>
                          <option value="extra">Charge</option>
                          <option value="hold">Hold Reason</option>
                      </select>
                      <input id="dd_val" class="form-control" placeholder="Value">
                      <input id="dd_desc" class="form-control" placeholder="Desc" style="display:none;">
                      <button class="btn btn-success" onclick="manDd('add')">Add</button>
                  </div>
                  <div class="d-flex gap-2 bg-light p-2 rounded"><select id="dd_del" class="form-select"></select><button class="btn btn-danger" onclick="delDd()">Delete</button></div>
               </div>
            </div>
         </div>
      </div>

    </div>
  </main>
</div>

<!-- MODALS -->
<div class="modal fade" id="reassignModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-body"><p class="small fw-bold">Transfer <span id="rId"></span> to:</p><select id="rStaff" class="form-select mb-3"></select><button class="btn btn-primary w-100 btn-sm" onclick="sendTransfer()">Send Request</button></div></div></div></div>

<div class="modal fade" id="holdModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-danger text-white border-0"><h5 class="modal-title fw-bold">Put Shipment On Hold</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body p-4">
        <div class="d-flex justify-content-between mb-3"><span class="fw-bold fs-5" id="modalHoldAwb"></span><span class="badge bg-light text-dark border" id="modalHoldNet"></span></div>
        <div class="mb-3"><label class="form-label small fw-bold text-muted">Reason</label><select id="modalHoldReason" class="form-select form-select-lg"></select></div>
        <div class="mb-4"><label class="form-label small fw-bold text-muted">Remarks</label><textarea id="modalHoldRem" class="form-control" rows="3" placeholder="Additional details..."></textarea></div>
        <button class="btn btn-danger w-100 btn-lg fw-bold" onclick="submitHoldFromModal()">Confirm Hold</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="actionModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-dark text-white border-0"><h5 class="modal-title fw-bold" id="actionModalTitle">Action</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body p-4">
         <p class="text-muted mb-3">Please provide mandatory remarks for this action.</p>
         <div class="mb-4"><label class="form-label small fw-bold text-muted">Remarks *</label><textarea id="actionModalRem" class="form-control" rows="3" required></textarea></div>
         <button class="btn btn-dark w-100 btn-lg fw-bold" onclick="submitActionFromModal()">Confirm Action</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="holdActionModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-warning text-dark border-0"><h5 class="modal-title fw-bold">Manage Holding</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body p-4">
         <div class="d-flex align-items-center mb-3"><h4 class="fw-bold m-0 me-2" id="ham_awb"></h4><span class="badge bg-light text-dark border" id="ham_net"></span></div>

         <div id="ham_na_section" style="display:none;">
             <div class="alert alert-info small"><i class="bi bi-info-circle me-1"></i> Update Network or Destination to clear this hold.</div>
             <div class="mb-3">
                 <label class="fun-label">Update Network</label>
                 <select id="ham_sel_net" class="form-select"></select>
             </div>
             <div class="mb-4">
                 <label class="fun-label">Update Destination</label>
                 <select id="ham_sel_dest" class="form-select"></select>
             </div>
             <button class="btn btn-success w-100 btn-lg fw-bold mb-2" onclick="hamSubmit()">Update & Release</button>
         </div>

         <div id="ham_norm_section" style="display:none;">
             <div class="alert alert-secondary small mb-3">Clear this holding manually.</div>
             <button class="btn btn-success w-100 btn-lg fw-bold mb-2" onclick="hamClear()">Clear Hold</button>
         </div>

         <button class="btn btn-dark w-100" onclick="hamRTO()">Mark RTO</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="viewRcModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold" id="vRc_title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body p-4" id="vRc_content"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="scanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Scan Barcode</h5><button type="button" class="btn-close" onclick="stopScanner()" data-bs-dismiss="modal"></button></div>
      <div class="modal-body text-center">
         <div id="reader" style="width: 100%;"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js" defer></script>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwBjoV46m3wTuitwgaTGunQd9KvltP27be_oKn_6ZeSAwK7qna1B99AxtEu44QR_98EGQ/exec";
const LOOKER_URL = "https://lookerstudio.google.com/embed/reporting/YOUR_REPORT_ID/page/YOUR_PAGE_ID";

let curUser="", curRole="", curReassign={}, curPerms=[];
let lastReqCount = 0;
let selectedHoldAwb = "";
let html5QrcodeScanner = null;
window.APP_DATA={staff:[], dropdowns:{}, overview:{auto:[],paper:[]}, workflow:{toAssign:[],toDo:[]}, manifest:[], holdings:[]};
window.tomInstances={client:null,dest:null,del:null,holdReason:null};

// --- INIT ---
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'short',day:'numeric'});
  setInterval(() => document.getElementById('timeDisplay').textContent = new Date().toLocaleTimeString('en-US'), 1000);
  document.getElementById('f_date').valueAsDate=new Date();
  document.getElementById('lookerFrame').src = LOOKER_URL;
});

function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('show'); document.getElementById('sidebarBackdrop').classList.toggle('show'); }
function showSpin(x){document.getElementById('spinner').style.display=x?'flex':'none';}
function toast(msg, type='success'){
   const t=document.createElement('div'); t.className=`toast align-items-center text-white bg-${type} border-0 show`; t.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
   document.getElementById('toastContainer').appendChild(t); setTimeout(()=>t.remove(),3000);
}

async function callApi(d){ try{const r=await fetch(API_URL,{method:"POST",body:JSON.stringify(d)}); return await r.json();}catch(e){return{result:"error",message:e.toString()};}}
async function fetchGet(a){ try{const r=await fetch(`${API_URL}?action=${a}&user=${encodeURIComponent(curUser)}&_t=${new Date().getTime()}`); return await r.json();}catch(e){return{result:"error"};}}

window.doLogin=async function(){
  showSpin(true); const u=document.getElementById('uIn').value, p=document.getElementById('pIn').value;
  const r=await callApi({action:"login",username:u,password:p});
  if(r.result==="success"){
     curUser=r.username; curRole=r.role; // Case sensitive role from backend? Backend returns as is.
     document.getElementById('userDisplay').textContent=r.name;
     document.getElementById('loginSection').style.display='none';
     document.getElementById('appSection').style.display='flex';
     syncData(true);
     if (curRole.toLowerCase() === 'staff') { switchTab('inbound'); }
  } else { showSpin(false); document.getElementById('loginError').textContent=r.message; document.getElementById('loginError').style.display='block'; }
}
window.logout=function(){location.reload();}
window.refreshApp=async function(){ showSpin(true); await syncData(false); showSpin(false); toast("Data Refreshed"); }

async function syncData(init=false){
  try {
     const r = await fetchGet('getAllData');
     if(r.result==="success"){
        window.APP_DATA = r;
        // Fix: Use role from backend if available, else keep existing login role
        if(r.role) curRole = r.role;
        curPerms = r.perms || [];

        if(curRole === 'Admin' || curRole === 'Owner') {
            const newCount = r.stats.requests || 0;
            if(!init && newCount > lastReqCount) toast(`<strong>New Transfer Request!</strong><br>${newCount} pending actions.`, 'danger');
            lastReqCount = newCount;
        }
        updateNavVisibility();
        if(init) initForms(); else updDd();
        renderUI();

        // Update Auto AWB Switch & Button
        if(window.APP_DATA.static && window.APP_DATA.static.config) {
            const enabled = window.APP_DATA.static.config.autoAwb;
            const sw = document.getElementById('autoAwbSwitch');
            if(sw) {
                sw.checked = enabled;
                document.getElementById('autoAwbLabel').textContent = enabled ? "Enabled" : "Disabled";
            }
            const btn = document.getElementById('btnAutoAwb');
            if(btn) btn.style.display = enabled ? 'block' : 'none';
        }
     } else {
        console.error("Sync Error:", r.message);
        if(init) document.getElementById('loginError').textContent = "Data Error: " + r.message;
     }
  } catch(e){ console.error(e); if(init) alert("Network/Parse Error: " + e.message); }
  if(init) showSpin(false);
}

function updateNavVisibility() {
    const role = curRole.toLowerCase();
    const p = curPerms;
    const show = (id, permName) => {
        const el = document.getElementById(id);
        if(role.includes('owner') || role.includes('admin') || p.includes(permName)) el.style.display='flex';
        else el.style.display='none';
    };

    show('nav-inbound', 'inbound');
    show('nav-overview', 'overview');
    show('nav-holdings', 'holdings');
    show('nav-taskhub', 'taskhub');
    show('nav-manifest', 'manifest');
    show('nav-receivers', 'manifest'); // Using manifest permission for now or public? Usually staff needs it. Let's assume overview/inbound perm?
    // Actually, let's make Receivers available to all authenticated if not restricted.
    document.getElementById('nav-receivers').style.display = 'flex';

    // Sidebar Title Logic
    const taskLabel = document.getElementById('taskLabel');
    if (taskLabel) {
        if (role.includes('admin') || role.includes('owner')) taskLabel.textContent = "Task Manager";
        else taskLabel.textContent = "My Tasks";
    }

    // Admin/Owner check - Normalized to lowercase for safety
    if(role.includes('owner') || role.includes('admin')) {
        document.getElementById('adminNavGroup').style.display='block';
    } else {
        document.getElementById('adminNavGroup').style.display='none';
    }

    // Redirect if current tab not allowed? Simplest is ensuring staff starts at allowed tab.
    // If init, doLogin handled it.
}

function renderUI(){
  const d=window.APP_DATA.overview, s=window.APP_DATA.stats;
  document.getElementById('ovInbound').textContent=s.inbound;
  document.getElementById('ovAuto').textContent=d.auto.length;
  document.getElementById('ovPaper').textContent=d.paper.length;
  document.getElementById('badgeAuto').textContent=d.auto.length;
  document.getElementById('badgePaper').textContent=d.paper.length;
  document.getElementById('totalHoldings').textContent=s.holdings;
  document.getElementById('ovHoldings').textContent=s.holdings;

  const la=document.getElementById('listAuto');
  if(!d.auto.length) la.innerHTML='<div class="text-center p-5 text-muted small">No Pending Automation</div>';
  else {
      la.innerHTML = d.auto.map(x => `
        <div class="list-item-stacked">
           <div class="list-row">
              <span class="list-val-bold">${x.id}</span>
              <div><span class="list-label">Weight</span><span class="list-val">${x.chgWgt}</span></div>
           </div>
           <div class="list-row">
              <div><span class="list-label">Network</span><span class="list-val">${x.net}</span></div>
              <div><span class="list-label">Boxes</span><span class="list-val">${x.boxes}</span></div>
           </div>
           <div class="list-row last">
              <div><span class="list-label">Client</span><span class="list-val">${(x.client||'').slice(-4)}</span></div>
              <div><span class="list-label">User</span><span class="list-val text-muted small">${x.user||'-'}</span></div>
           </div>
        </div>`).join('');
  }

  const lp=document.getElementById('listPaper');
  const sortedP = [...d.paper].sort((a,b)=>(a.assignee?1:-1)-(b.assignee?1:-1));
  if(!sortedP.length) lp.innerHTML='<div class="text-center p-5 text-muted small">No Pending Paperwork</div>';
  else {
      lp.innerHTML = sortedP.map(x => `
        <div class="list-item-stacked">
           <div class="list-row">
              <span class="list-val-bold">${x.id}</span>
              <div><span class="list-label">Weight</span><span class="list-val">${x.chgWgt}</span></div>
           </div>
           <div class="list-row">
              <div><span class="list-label">Network</span><span class="list-val">${x.net}</span></div>
              <div><span class="list-label">Network Number</span><span class="list-val font-monospace">${x.netNo||'-'}</span></div>
           </div>
           <div class="list-row last">
              <div><span class="list-label">Client</span><span class="list-val">${(x.client||'').slice(-4)}</span></div>
              <div><span class="list-label">Assigned To</span><span class="list-val text-primary fw-bold small">${x.assignee||'Unassigned'}</span></div>
           </div>
           <div class="mt-1 d-flex justify-content-end gap-2">
              <span class="badge bg-light text-dark border">Boxes: ${x.boxes}</span>
              <span class="badge bg-light text-dark border">Auto By: ${x.autoDoer||'-'}</span>
           </div>
        </div>`).join('');
  }

  renderTaskHub();
  if(document.getElementById('manifest-tab').style.display==='block') renderManifest();
  if(document.getElementById('holdings-tab').style.display==='block') renderHoldings();
  if(document.getElementById('receivers-tab').style.display==='block') renderReceivers();
  if(document.getElementById('admin-tab').style.display==='block') renderAdminPanel();
}

function renderTaskHub(){
   const role = curRole.toLowerCase();
   if(role === 'admin' || role === 'owner') {
      document.getElementById('adminTaskView').style.display = 'block'; document.getElementById('staffTaskView').style.display = 'none';
      const pt=document.getElementById('poolBody'); let opts=`<option value="">Select Staff...</option>`; if(window.APP_DATA.static && window.APP_DATA.static.staff) window.APP_DATA.static.staff.forEach(s=>opts+=`<option value="${s}">${s}</option>`);
      pt.innerHTML = window.APP_DATA.adminPool.map(x => { let assignVal = x.assignee || ""; return `<tr><td class="fw-bold font-monospace">${x.id}</td><td>${x.netNo||'-'}</td><td>${x.net}</td><td>${x.chgWgt}</td><td><small class="text-muted">${x.details}</small></td><td>${x.client.slice(-4)}</td><td class="text-center">${assignVal}</td><td><div class="d-flex gap-2 align-items-center"><select id="adm_as_${x.id}" class="form-select form-select-sm" style="width:120px">${opts}</select><button class="btn btn-primary btn-sm fw-bold" onclick="actAssign('${x.id}','adm_as_')">Assign</button></div></td></tr>`; }).join('');
   } else {
      document.getElementById('adminTaskView').style.display = 'none'; document.getElementById('staffTaskView').style.display = 'block';
      const wf=window.APP_DATA.workflow; const ca=document.getElementById('contAssign');
      if(!wf.toAssign.length) ca.innerHTML='<div class="col-12 text-center text-muted small py-4">No shipments automated by you</div>';
      else { let opts=`<option value="">Transfer To...</option>`; if(window.APP_DATA.static && window.APP_DATA.static.staff) window.APP_DATA.static.staff.forEach(s=>opts+=`<option value="${s}">${s}</option>`); ca.innerHTML = wf.toAssign.map(x => `<div class="col-12"><div class="panel-card p-3 border-info border-start border-4"><div class="fw-bold">${x.id}</div><div class="small text-muted mb-2">${x.client}  ${x.net}</div><div class="input-group input-group-sm"><select id="direct_tr_${x.id}" class="form-select">${opts}</select><button class="btn btn-primary" onclick="actDirectTransfer('${x.id}')">Transfer</button></div></div></div>`).join(''); }
      const ct=document.getElementById('contTodo');
      if(!wf.toDo.length) ct.innerHTML='<div class="col-12 text-center text-muted small py-4">No tasks assigned to you</div>';
      else { ct.innerHTML = wf.toDo.map(x => `<div class="col-12"><div class="panel-card p-3 border-warning border-start border-4"><div class="d-flex justify-content-between"><div><div class="fw-bold">${x.id}</div><div class="small text-muted">${x.subtitle}</div></div><button class="btn btn-sm btn-light" onclick="openReassign('${x.id}','Paperwork')"><i class="bi bi-arrow-left-right"></i></button></div><div class="small text-primary my-2">${x.details}</div><button class="btn btn-success w-100 btn-sm rounded-pill" onclick="actComplete('${x.id}')">Mark Complete</button></div></div>`).join(''); }
   }
}

// --- HOLDINGS UI & LOGIC ---
window.renderHoldings = function() {
    const list = document.getElementById('holdingsList');
    const items = window.APP_DATA.holdings || [];
    if(!items.length) list.innerHTML='<tr><td colspan="7" class="text-center p-5 text-muted"><h5>No Active Holdings</h5><p class="small">Shipments placed on hold will appear here.</p></td></tr>';
    else {
        list.innerHTML = items.map(x =>
            `<tr>
                <td class="clickable-cell font-monospace" onclick="openHoldAction('${x.id}')">${x.id}</td>
                <td class="clickable-cell" onclick="openHoldAction('${x.id}')">${x.netNo||'-'}</td>
                <td>${x.client}</td>
                <td><span class="badge bg-danger bg-opacity-10 text-danger">${x.holdReason}</span></td>
                <td><small class="text-muted text-wrap" style="max-width:200px;">${x.holdRem}</small></td>
                <td><small>${x.user}</small></td>
            </tr>`
        ).join('');
    }
}

window.searchHoldings = function() {
    const awb = document.getElementById('holdSearchAwb').value.toLowerCase().trim();
    const netSearch = document.getElementById('holdSearchNet').value.toLowerCase().trim();
    const resPanel = document.getElementById('holdResultPanel');

    if(!awb && !netSearch) { resPanel.style.display='none'; return; }

    const all = [...window.APP_DATA.overview.auto, ...window.APP_DATA.overview.paper, ...window.APP_DATA.holdings, ...window.APP_DATA.manifest];
    const match = all.find(x => (awb && x.id.toLowerCase().includes(awb)) || (netSearch && x.netNo && x.netNo.toLowerCase().includes(netSearch)));

    if(match) {
        const isOnHold = match.holdStatus === "On Hold";
        const isNA = (match.net === "NA" || match.net === "N/A" || match.dest === "NA" || match.dest === "N/A");

        let actionBtn = "";

        if(isOnHold) {
            if (isNA) {
                // Generate Options from Dropdowns
                const nets = window.APP_DATA.static.dropdowns.networks.map(n => `<option value="${n}">${n}</option>`).join('');
                const dests = window.APP_DATA.static.dropdowns.destinations.map(d => `<option value="${d}">${d}</option>`).join('');

                actionBtn = `
                    <div class="alert alert-warning small p-2 mb-2">Update Details to Clear Hold</div>
                    <select id="fix_net" class="form-select mb-2"><option value="" disabled selected>Select Network</option>${nets}</select>
                    <select id="fix_dest" class="form-select mb-2"><option value="" disabled selected>Select Destination</option>${dests}</select>
                    <button class="btn btn-warning w-100 mb-2 fw-bold" onclick="submitCorrection('${match.id}')">Update & Save</button>
                `;
            } else {
                actionBtn = `
                    <button class="btn btn-success btn-lg w-100 mb-2" onclick="actClearHold('${match.id}')">Clear Hold</button>
                    <button class="btn btn-dark btn-lg w-100" onclick="actRTO('${match.id}')">Mark RTO</button>
                `;
            }
        } else {
            actionBtn = `<button class="btn btn-danger btn-lg w-100" onclick="openHoldModal('${match.id}', '${match.netNo||'-'}')">Put On Hold</button>`;
        }

        resPanel.innerHTML = `
            <div class="panel-card border-2 ${isOnHold ? 'border-warning' : 'border-success'} p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge ${isOnHold ? 'bg-warning text-dark' : 'bg-success'} me-2">${isOnHold ? 'CURRENTLY ON HOLD' : 'ACTIVE STATUS'}</span>
                            <h4 class="fw-bold m-0">${match.id}</h4>
                        </div>
                        <div class="row g-3 small text-muted">
                            <div class="col-auto"><strong class="text-dark">Net No:</strong> ${match.netNo||'-'}</div>
                            <div class="col-auto"><strong class="text-dark">Client:</strong> ${match.client}</div>
                            <div class="col-auto"><strong class="text-dark">Network:</strong> <span class="${(match.net==='NA'||match.net==='N/A')?'text-danger fw-bold':''}">${match.net}</span></div>
                            <div class="col-auto"><strong class="text-dark">Dest:</strong> <span class="${(match.dest==='NA'||match.dest==='N/A')?'text-danger fw-bold':''}">${match.dest}</span></div>
                            <div class="col-auto"><strong class="text-dark">Weight:</strong> ${match.chgWgt}</div>
                        </div>
                    </div>
                    <div class="col-md-4 mt-3 mt-md-0">
                        ${actionBtn}
                    </div>
                </div>
            </div>
        `;
        resPanel.style.display='block';

        // Pre-select current values if in correction mode
        if(isNA && isOnHold) {
             const fn = document.getElementById('fix_net');
             const fd = document.getElementById('fix_dest');
             if(fn && match.net !== "NA" && match.net !== "N/A") fn.value = match.net;
             if(fd && match.dest !== "NA" && match.dest !== "N/A") fd.value = match.dest;
        }
    } else {
        resPanel.innerHTML = `<div class="alert alert-secondary text-center py-4">No shipment found matching your search.</div>`;
        resPanel.style.display='block';
    }
}

window.clearHoldSearch = function() {
    document.getElementById('holdSearchAwb').value='';
    document.getElementById('holdSearchNet').value='';
    document.getElementById('holdResultPanel').style.display='none';
}

window.openHoldModal = function(id, netNo) {
    selectedHoldAwb = id;
    document.getElementById('modalHoldAwb').textContent = id;
    document.getElementById('modalHoldNet').textContent = netNo;
    
    // Check if data exists, if not warn
    if (!window.APP_DATA || !window.APP_DATA.static || !window.APP_DATA.static.dropdowns) {
        alert("Data not loaded yet. Please wait or refresh.");
        return;
    }
    const reasons = window.APP_DATA.static.dropdowns.holdReasons || [];

    // Destroy previous
    if(window.tomInstances.holdReason) {
        window.tomInstances.holdReason.destroy();
        window.tomInstances.holdReason = null;
    }

    // Clear and rebuild select options manually to ensure clean state
    const sel = document.getElementById('modalHoldReason');
    sel.innerHTML = `<option value="">Select Reason...</option>`;

    // Init TomSelect with explicit options
    // Transforming data to handle formatting requirements: CODE (Bold/Upper), Desc (Sentence)
    const tsOptions = reasons.map(r => ({
        value: r.code,
        code: r.code.toUpperCase(),
        desc: r.desc.charAt(0).toUpperCase() + r.desc.slice(1).toLowerCase()
    }));
    
    window.tomInstances.holdReason = new TomSelect("#modalHoldReason",{
        create: false,
        dropdownParent: 'body',
        options: tsOptions,
        items: [],
        valueField: 'value',
        labelField: 'code',
        searchField: ['code', 'desc'],
        render: {
            option: function(data, escape) {
                return `<div><span class="fw-bold">${escape(data.code)}</span> - <span>${escape(data.desc)}</span></div>`;
            },
            item: function(data, escape) {
                return `<div><span class="fw-bold">${escape(data.code)}</span> - <span>${escape(data.desc)}</span></div>`;
            }
        }
    });

    document.getElementById('modalHoldRem').value = "";
    new bootstrap.Modal(document.getElementById('holdModal')).show();
}

window.submitHoldFromModal = async function() {
    const r = document.getElementById('modalHoldReason').value;
    const rem = document.getElementById('modalHoldRem').value;
    if(!r) return alert("Select Reason");
    
    bootstrap.Modal.getInstance(document.getElementById('holdModal')).hide();
    document.getElementById('holdResultPanel').style.display='none';
    
    await callApi({action:"manageHold", subAction:"set", awb:selectedHoldAwb, reason:r, remarks:rem});
    syncData(false); toast("Shipment put on Hold");
    clearHoldSearch();
}

// --- SCANNER ---
let scanTargetId = 'holdSearchAwb'; // Default
window.startScanner = function(targetId) {
    if(targetId) scanTargetId = targetId;
    else scanTargetId = 'holdSearchAwb';

    new bootstrap.Modal(document.getElementById('scanModal')).show();
    html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
}
function onScanSuccess(decodedText, decodedResult) {
    const el = document.getElementById(scanTargetId);
    if(el) {
        el.value = decodedText;
        if(scanTargetId === 'holdSearchAwb') searchHoldings();
    }
    stopScanner();
    // Beep sound
    const audio = new Audio('https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3');
    audio.play();
    bootstrap.Modal.getInstance(document.getElementById('scanModal')).hide();
}
window.stopScanner = function() {
    if(html5QrcodeScanner) { html5QrcodeScanner.clear(); html5QrcodeScanner = null; }
}

let currentActionType = "";
window.actClearHold = function(id) {
    currentActionType = "clear";
    selectedHoldAwb = id;
    document.getElementById('actionModalTitle').textContent = "Clear Hold - " + id;
    document.getElementById('actionModalRem').value = "";
    new bootstrap.Modal(document.getElementById('actionModal')).show();
}

window.actRTO = function(id) {
    currentActionType = "rto";
    selectedHoldAwb = id;
    document.getElementById('actionModalTitle').textContent = "Mark RTO - " + id;
    document.getElementById('actionModalRem').value = "";
    new bootstrap.Modal(document.getElementById('actionModal')).show();
}

window.submitActionFromModal = async function() {
    const rem = document.getElementById('actionModalRem').value;
    if(!rem.trim()) return alert("Remarks are mandatory");

    bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
    document.getElementById('holdResultPanel').style.display='none';

    await callApi({action:"manageHold", subAction:currentActionType, awb:selectedHoldAwb, remarks:rem});
    syncData(false); toast("Action Completed");
    clearHoldSearch();
}

// --- ADMIN ---
window.changeRole = async function(target, newRole) {
    if(!confirm(`Change ${target} to ${newRole}?`)) return;
    await callApi({action:"manageUserRole", requester:curUser, targetUser:target, newRole:newRole});
    loadUsers();
}
window.updatePerms = async function(target, permStr) {
    // Collect checkboxes
    // Implementation simplified for now: pass csv
    await callApi({action:"updateUserPerms", requester:curUser, targetUser:target, perms:permStr});
    loadUsers();
}
window.savePerms = async function(target) {
    const chks = document.querySelectorAll(`.perm-chk-${target}:checked`);
    const perms = Array.from(chks).map(c=>c.value).join(',');
    await callApi({action:"updateUserPerms", requester:curUser, targetUser:target, perms:perms});
    // loadUsers(); // Keep state
    toast("Permissions Saved Successfully");
}

async function renderAdminPanel(){
   if(curRole.toLowerCase()==='staff') return; // Double check
   const r=await fetchGet('getUsers'); const t=document.getElementById('userList');
   if(r.users) t.innerHTML = r.users.map(u => {
       const isMe = u.user === curUser;
       const isOwner = u.role === "Owner";
       const isAdmin = u.role === "Admin";
       const canEdit = (curRole.toLowerCase() === "owner");

       let roleActions = "";
       if(canEdit && !isMe && !isOwner) {
           roleActions = `
             <div class="dropdown d-inline-block">
               <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">${u.role}</button>
               <ul class="dropdown-menu">
                 <li><a class="dropdown-item" onclick="changeRole('${u.user}', 'Admin')">Promote to Admin</a></li>
                 <li><a class="dropdown-item" onclick="changeRole('${u.user}', 'Staff')">Demote to Staff</a></li>
               </ul>
             </div>`;
       } else {
           roleActions = `<span class="badge ${isOwner?'bg-primary':(isAdmin?'bg-info':'bg-secondary')}">${u.role}</span>`;
       }

       // Permissions
       const allPerms = ['inbound','overview','holdings','taskhub','manifest'];
       const userPerms = (u.perms||"").split(',');
       let permUI = "";
       if(u.role === "Staff") {
           if(canEdit || curRole.toLowerCase() === 'admin') {
               // Show checkboxes
               permUI = allPerms.map(p => {
                   const label = p.charAt(0).toUpperCase() + p.slice(1);
                   return `
                     <div class="form-check form-check-inline d-flex align-items-center m-0 me-2">
                       <input class="form-check-input perm-chk-${u.user}" type="checkbox" value="${p}" ${userPerms.includes(p)?'checked':''} style="margin-top:0;">
                       <label class="form-check-label small ms-1" style="font-size:0.75rem; vertical-align:middle;">${label}</label>
                     </div>`;
               }).join('');
               permUI += `<button class="btn btn-xs btn-primary ms-2 py-0" style="font-size:0.7rem" onclick="savePerms('${u.user}')">Save</button>`;
           } else {
               permUI = userPerms.join(', ');
           }
       } else {
           permUI = "<small class='text-muted'>Full Access</small>";
       }

       return `<tr>
         <td>${u.user}</td>
         <td style="cursor:pointer; font-family:monospace;" onclick="togglePass(this)" data-pass="${u.pass||''}">****</td>
         <td>${u.name}</td>
         <td>${roleActions}</td>
         <td>${permUI}</td>
         <td><div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary py-0" onclick="changePass('${u.user}')"><i class="bi bi-key"></i></button>
            ${canEdit && !isOwner ? `<button class="btn btn-sm btn-outline-danger py-0" onclick="delUser('${u.user}')"><i class="bi bi-trash"></i></button>` : ''}
         </div></td>
       </tr>`;
   }).join('');

   const rr=await fetchGet('getAdminRequests'); const rl=document.getElementById('reqList'); if(rr.requests) rl.innerHTML = rr.requests.map(x => `<div class="list-group-item d-flex justify-content-between"><small><strong>${x.taskId}</strong> (${x.type})<br>${x.by} to ${x.to}</small><div><button class="btn btn-sm btn-success py-0" onclick="decideTr(${x.reqId},'${x.taskId}','${x.type}','${x.to}','Approve')">ok</button><button class="btn btn-sm btn-danger py-0" onclick="decideTr(${x.reqId},'${x.taskId}','${x.type}','${x.to}','Reject')">x</button></div></div>`).join('');
}

// ... (Rest of existing actions: actAssign, etc. - Ensure no duplicates)
// Copying remaining functions from previous to ensure nothing lost
async function actAssign(id, pfx='as_'){ const s=document.getElementById(pfx+id).value; if(!s) return alert("Select Staff"); await callApi({action:"assignTask", id:id, staff:s, assigner:curUser}); syncData(false); toast("Task Assigned"); }
async function actDirectTransfer(id){ const s=document.getElementById('direct_tr_'+id).value; if(!s) return alert("Select Staff"); if(!confirm(`Transfer ${id} to ${s}?`)) return; const card = document.getElementById('direct_tr_'+id).closest('.col-12'); if(card) card.remove(); await callApi({action:"directTransfer", taskId:id, to:s, by:curUser}); toast("Transferred Successfully"); }
async function actComplete(id){ if(!confirm(`Complete paperwork for ${id}?`)) return; await callApi({action:"markPaperworkDone", id:id}); syncData(false); toast("Task Completed"); }

window.switchTab=function(t){
   document.querySelectorAll('.nav-item-custom').forEach(e=>e.classList.remove('active'));
   document.getElementById('nav-'+t).classList.add('active');
   document.querySelectorAll('.tab-view').forEach(e=>e.style.display='none');
   document.getElementById(t+'-tab').style.display='block';
   let title = t.charAt(0).toUpperCase() + t.slice(1);
   if(t==='taskhub') {
       const r = curRole.toLowerCase();
       title = (r==='admin' || r==='owner') ? 'Task Manager' : 'My Tasks';
   }
   document.getElementById('pageTitle').textContent = title;
   if(document.getElementById('sidebar').classList.contains('show')) toggleSidebar();
   if(t==='manifest') renderManifest();
   if(t==='admin') renderAdminPanel();
   if(t==='holdings') renderHoldings();
   if(t==='receivers') renderReceivers();
}
function initForms(){
   const dd=window.APP_DATA.static.dropdowns;
   if(dd) { fillSel('f_net', dd.networks); window.tomInstances.client = new TomSelect("#f_client",{create:false, maxOptions: null, dropdownParent:'body', placeholder:"Select Client..."}); window.tomInstances.dest = new TomSelect("#f_dest",{create:false, maxOptions: null, dropdownParent:'body', placeholder:"Select Destination..."}); updDd(); }
}
function updDd(){
   if(!window.APP_DATA.static) return;
   const dd=window.APP_DATA.static.dropdowns; if(!dd) return;
   fillSel('f_net', dd.networks); const mn=document.getElementById('man_net'); if(mn && mn.options.length<=1 && dd.networks){ let opts=''; dd.networks.forEach(x=>opts+=`<option value="${x}">${x}</option>`); mn.innerHTML+=opts; }
   if(window.tomInstances.client && dd.clients){ window.tomInstances.client.clearOptions(); dd.clients.forEach(x=>window.tomInstances.client.addOption({value:x,text:x})); window.tomInstances.client.sync(); }
   if(window.tomInstances.dest && dd.destinations){ window.tomInstances.dest.clearOptions(); dd.destinations.forEach(x=>window.tomInstances.dest.addOption({value:x,text:x})); window.tomInstances.dest.sync(); }
   const ex=document.getElementById('f_extra'); if(ex && dd.extraCharges) ex.innerHTML=dd.extraCharges.map(x=>`<div class="form-check"><input class="form-check-input" type="checkbox" value="${x}"><label class="form-check-label small">${x}</label></div>`).join('');

   if(curRole==='admin' || curRole==='owner'){
     const cat=document.getElementById('dd_cat').value;
     if(cat==="hold") document.getElementById('dd_desc').style.display='block'; else document.getElementById('dd_desc').style.display='none';
     let targetList = [];
     if(cat==="hold") targetList = dd.holdReasons ? dd.holdReasons.map(x=>x.code) : [];
     else targetList = dd[{'network':'networks','client':'clients','destination':'destinations','extra':'extraCharges'}[cat]];
     const delSel=document.getElementById('dd_del'); if(targetList) delSel.innerHTML=targetList.map(x=>`<option value="${x}">${x}</option>`).join('');
   }
}
function fillSel(id, arr){ const e=document.getElementById(id); if(!e||e.options.length>1)return; if(arr) { let html=''; arr.forEach(x=>html+=`<option value="${x}">${x}</option>`); e.innerHTML+=html; } }
window.toggleAllPaperwork = function(el) { document.querySelectorAll('.pw-chk').forEach(c => { if(c.value !== "N/A") c.checked = el.checked; }); }
window.exportOverview = function(type) { const d = window.APP_DATA.overview[type] || []; if(!d.length) return alert("Nothing to export"); const data = d.map(x => ({ "AWB": x.id, "Network": x.net, "Client": x.client, "User/Auto": x.user||x.autoDoer, "Boxes": x.boxes, "Weight": x.chgWgt })); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), type.toUpperCase()); XLSX.writeFile(wb, `Overview_${type}.xlsx`); };

// --- FORM SUBMIT ---
document.getElementById('shipForm').onsubmit = async (e)=>{
   e.preventDefault();
   const cl = document.getElementById('f_client').value; if(cl.includes("COUNTER SALE CASH - CASH")) { const pt = parseFloat(document.getElementById('f_payTotal').value)||0; if(pt <= 0) return alert("Total Amount Required for Cash Sale"); }
   let pw = []; document.querySelectorAll('.pw-chk:checked').forEach(c => pw.push(c.value)); if(pw.length === 0) return alert("Please select required Paperwork");
   showSpin(true); let boxes=[], extra=[]; document.querySelectorAll('#boxTable tr').forEach((tr,i)=>{ let inps=tr.querySelectorAll('input'); if(inps.length) boxes.push({no:i+1, weight:inps[0].value, length:inps[1].value, breath:inps[2].value, height:inps[3].value}); }); document.querySelectorAll('#f_extra input:checked').forEach(c=>extra.push(c.value));

   // Add Shipment Type to Extra Charges
   const stype = document.querySelector('input[name="stype"]:checked');
   if(stype) extra.push("Type: " + stype.value);

   const r = await callApi({ action: 'submit', username: curUser, awb: document.getElementById('f_awb').value, date: document.getElementById('f_date').value, type: document.getElementById('f_type').value, network: document.getElementById('f_net').value, client: document.getElementById('f_client').value, destination: document.getElementById('f_dest').value, totalBoxes: document.getElementById('f_boxes').value, extraCharges: extra.join(', '), extraRemarks: document.getElementById('f_remarks').value, boxes: boxes, payTotal: document.getElementById('f_payTotal').value || 0, payPaid: document.getElementById('f_payPaid').value || 0, payPending: document.getElementById('f_payPending').value || 0, paperwork: pw.join(', ') });
   showSpin(false); if(r.result==='success') { toast("Entry Saved"); resetForm(); syncData(false); } else alert(r.message);
};
function resetForm(){
    document.getElementById('shipForm').reset();
    document.getElementById('boxTable').innerHTML='';
    if(window.tomInstances.client) window.tomInstances.client.clear();
    if(window.tomInstances.dest) window.tomInstances.dest.clear();
    document.getElementById('f_date').valueAsDate=new Date();
    document.getElementById('st_reg').checked = true; // Default
    chkStype({value:'Regular'}); // Reset -FRT
}
window.chkDox=function(){ const t=document.getElementById('f_type').value; if(t==='Dox'){ document.getElementById('f_boxes').value=1; genBoxes(); } }
window.genBoxes=function(){ const n=document.getElementById('f_boxes').value; const tb=document.getElementById('boxTable'); let html = ''; for(let i=1;i<=n;i++) html += `<tr><td>${i}</td><td><input type="number" step="any" class="form-control form-control-sm" required oninput="cBox(this)"></td><td><input type="number" step="any" class="form-control form-control-sm" oninput="cBox(this)"></td><td><input type="number" step="any" class="form-control form-control-sm" oninput="cBox(this)"></td><td><input type="number" step="any" class="form-control form-control-sm" oninput="cBox(this)"></td><td class="val-chg">0</td></tr>`; tb.innerHTML = html; }
window.cBox=function(el){ const i=el.closest('tr').querySelectorAll('input'); const w=parseFloat(i[0].value)||0, v=(parseFloat(i[1].value)*parseFloat(i[2].value)*parseFloat(i[3].value))/5000; el.closest('tr').querySelector('.val-chg').textContent=Math.max(w,v).toFixed(2); let tot=0; document.querySelectorAll('.val-chg').forEach(x=>tot+=parseFloat(x.textContent)); document.getElementById('f_totalChg').value=tot.toFixed(2); }
window.cPay=function(){ const t=parseFloat(document.getElementById('f_payTotal').value)||0; const p=parseFloat(document.getElementById('f_payPaid').value)||0; document.getElementById('f_payPending').value = (t-p).toFixed(2); }

window.manDd=async function(act){
    const v=document.getElementById('dd_val').value, c=document.getElementById('dd_cat').value, d=document.getElementById('dd_desc').value; if(!v)return;
    await callApi({action:"manageData",subAction:act,category:c,value:v,desc:d}); document.getElementById('dd_val').value=''; document.getElementById('dd_desc').value=''; syncData(false);
}
window.delDd=async function(){ const v=document.getElementById('dd_del').value, c=document.getElementById('dd_cat').value; if(!v)return; if(confirm("Delete?")) await callApi({action:"manageData",subAction:"delete",category:c,value:v}); syncData(false); }
window.addUser=async function(){ await callApi({action:"addUser", u:document.getElementById('nu_u').value, p:document.getElementById('nu_p').value, n:document.getElementById('nu_n').value, r:document.getElementById('nu_r').value}); document.getElementById('nu_u').value=''; document.getElementById('nu_p').value=''; document.getElementById('nu_n').value=''; loadUsers(); }
window.delUser=async function(u){ if(confirm("Del?")) await callApi({action:"deleteUser", username:u}); loadUsers(); }
window.changePass=async function(u){ const p = prompt("New Password for "+u+":"); if(p) { await callApi({action:"changePassword", username:u, newPass:p}); loadUsers(); alert("Password Changed"); } }
window.togglePass=function(el){
    const pass = el.getAttribute('data-pass');
    if(!pass) return toast("Password not available", "warning");
    el.textContent = el.textContent === '****' ? pass : '****';
}
window.decideTr=async function(rid,tid,typ,to,dec){ showSpin(true); await callApi({action:"approveTransfer", reqId:rid, taskId:tid, type:typ, to:to, decision:dec}); renderAdminPanel(); showSpin(false); }
window.reloadFrame=function(){ document.getElementById('lookerFrame').src += ''; }
window.exportPool=function(){ const data = window.APP_DATA.adminPool.map(x=>({"AWB":x.id,"Client":x.client,"Net":x.net,"Status":x.assignee?"Assigned":"Unassigned","Assignee":x.assignee||""})); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Pool"); XLSX.writeFile(wb, "Pool.xlsx"); }
window.switchManifestView = function(view) { document.querySelectorAll('#manTabs .nav-link').forEach(el => el.classList.remove('active')); const idx = view === 'pending' ? 0 : 1; document.querySelectorAll('#manTabs .nav-link')[idx].classList.add('active'); document.getElementById('man-pending-view').style.display = view === 'pending' ? 'block' : 'none'; document.getElementById('man-history-view').style.display = view === 'history' ? 'block' : 'none'; if(view === 'pending') renderManifest(); if(view === 'history') renderManifestHistory(); }
window.renderManifest = function() { const net = document.getElementById('man_net').value; const list = document.getElementById('manifestList'); const items = window.APP_DATA.manifest || []; const filtered = net ? items.filter(x => x.net === net && !x.batchNo) : []; if (!net || filtered.length === 0) { list.innerHTML = ''; document.getElementById('manifestEmptyState').style.display = 'block'; document.getElementById('manifestEmptyState').querySelector('h6').textContent = !net ? "No Network Selected" : `No Pending Items for ${net}`; return; } document.getElementById('manifestEmptyState').style.display = 'none'; list.innerHTML = filtered.map(x => `<tr><td class="ps-4"><input type="checkbox" class="form-check-input batch-check" value="${x.id}"></td><td class="fw-bold font-monospace">${x.id}</td><td>${new Date(x.date).toLocaleDateString()}</td><td>${x.dest}</td><td>${x.net}</td><td>${x.netNo||'-'}</td><td>${x.boxes}</td><td>${x.chgWgt}</td><td>${x.client.slice(-4)}</td><td class="pe-4 text-end"><span class="badge bg-success">Ready</span></td></tr>`).join(''); };
window.toggleAllMan = function(el) { document.querySelectorAll('.batch-check').forEach(c => c.checked = el.checked); }
window.createBatch = async function() { const net = document.getElementById('man_net').value; if(!net) return alert("Select Network"); const chks = document.querySelectorAll('.batch-check:checked'); if(chks.length === 0) return alert("Select at least one item"); const ids = Array.from(chks).map(c => c.value); const batchId = `${net}-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(Math.random()*1000)}`; const manifestDate = new Date().toLocaleDateString(); if(!confirm(`Generate Manifest Batch "${batchId}" for ${ids.length} items?`)) return; window.APP_DATA.manifest.forEach(x => { if(ids.includes(x.id)) { x.batchNo = batchId; x.manifestDate = manifestDate; } }); exportBatch(batchId); renderManifest(); await callApi({ action: 'updateManifestBatch', batchNo: batchId, ids: ids, date: manifestDate, network: net, user: curUser }); toast("Batch Created & Exported"); };
window.renderManifestHistory = function() { const con = document.getElementById('batchContainer'); const all = window.APP_DATA.manifest || []; const batches = {}; all.forEach(x => { if(x.batchNo) { if(!batches[x.batchNo]) batches[x.batchNo] = []; batches[x.batchNo].push(x); } }); const keys = Object.keys(batches).sort().reverse(); if(keys.length === 0) { con.innerHTML = ''; document.getElementById('batchEmptyState').style.display = 'block'; return; } document.getElementById('batchEmptyState').style.display = 'none'; con.innerHTML = keys.map(k => { const group = batches[k]; const net = group[0].net; const date = group[0].manifestDate || "N/A"; const count = group.length; const rows = group.map(g => `<tr><td>${g.id}</td><td>${g.dest}</td><td>${g.chgWgt}</td></tr>`).join(''); return `<div class="col-md-6 col-xl-4"><div class="panel-card h-100"><div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light"><div><div class="fw-bold text-primary">${k}</div><div class="small text-muted">${date}  ${net}</div></div><span class="badge bg-primary rounded-pill">${count} Items</span></div><div class="p-3"><div class="d-flex gap-2 mb-3"><button class="btn btn-sm btn-outline-primary flex-fill" onclick="exportBatch('${k}')"><i class="bi bi-download me-1"></i> Re-Export</button><button class="btn btn-sm btn-outline-secondary flex-fill" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_${k}">View Items</button></div><div class="collapse" id="collapse_${k}"><div class="table-responsive border rounded" style="max-height:200px; overflow-y:auto;"><table class="table table-sm table-striped mb-0 small"><thead><tr><th>AWB</th><th>Destination</th><th>Weight</th></tr></thead><tbody>${rows}</tbody></table></div></div></div></div></div>`; }).join(''); }
window.exportBatch = function(batchId) { const items = window.APP_DATA.manifest.filter(x => x.batchNo === batchId); if(!items.length) return alert("Empty Batch"); const data = items.map(x => ({ "AWB": x.id, "Date": x.date, "Network": x.net, "Network No": x.netNo, "Client": x.client.slice(-4), "Destination": x.dest, "Pieces": x.boxes, "Weight": x.chgWgt, "Type": x.type, "Batch": x.batchNo })); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), batchId); XLSX.writeFile(wb, `Manifest_${batchId}.xlsx`); };

// NEW FUNCTIONS
window.generateAwb = async function() {
    showSpin(true);
    const r = await callApi({action:"generateAwb"});
    showSpin(false);
    if(r.result === "success") { document.getElementById('f_awb').value = r.awb; }
    else alert(r.message);
}

window.submitCorrection = async function(awb) {
    const net = document.getElementById('fix_net').value;
    const dest = document.getElementById('fix_dest').value;
    if(!net || !dest || net==="NA" || dest==="NA") return alert("Please select valid Network and Destination");
    showSpin(true);
    const r = await callApi({action:"updateShipmentDetails", awb: awb, network: net, destination: dest});
    if(r.result === "success") {
        await syncData(false);
        // Auto clear hold? User said "can only be cleared if... in the process of clearing it".
        // Let's assume after update, user still needs to click Clear Hold, OR we do it now.
        // User said "can only be cleared if ... selected ... in the process".
        // I'll re-render search, now they can see Clear Hold button because NA check passes.
        toast("Details Updated. You can now Clear Hold.");
        searchHoldings(); // Re-render to show Clear button
    } else { alert(r.message); }
    showSpin(false);
}

window.renderReceivers = async function() {
    const t = document.getElementById('rcList');
    t.innerHTML = '<tr><td colspan="8" class="text-center p-4">Loading...</td></tr>';
    const r = await fetchGet('getRecent');
    if(r.result === "success" && r.shipments) {
        window.APP_DATA.recent = r.shipments; // Cache for printing
        t.innerHTML = r.shipments.map(x => `
            <tr>
                <td><input type="checkbox" class="form-check-input rc-chk" value="${x.id}"></td>
                <td class="font-monospace fw-bold">${x.id}</td>
                <td>${new Date(x.date).toLocaleDateString()}</td>
                <td>${(x.client||'').slice(-4)}</td>
                <td>${x.dest}</td>
                <td>${x.wgt}</td>
                <td><span class="badge bg-secondary bg-opacity-10 text-secondary">${x.status}</span></td>
                <td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick="viewRc('${x.id}')">View</button></td>
            </tr>
        `).join('');
    } else {
        t.innerHTML = '<tr><td colspan="8" class="text-center p-4">No Data</td></tr>';
    }
}

window.toggleRc = function(el) { document.querySelectorAll('.rc-chk').forEach(c => c.checked = el.checked); }

window.exportReceiverExcel = function(singleId=null) {
    const items = [];
    if(singleId) {
        const item = window.APP_DATA.recent.find(x => x.id === singleId);
        if(item) items.push(item);
    } else {
        const chks = document.querySelectorAll('.rc-chk:checked');
        if(chks.length === 0) return alert("Select shipments to export");
        const ids = Array.from(chks).map(c => c.value);
        items.push(...window.APP_DATA.recent.filter(x => ids.includes(x.id)));
    }
    if(items.length===0) return;

    const wb = XLSX.utils.book_new();
    const ws_data = [];

    items.forEach(x => {
        const date = new Date(x.date).toLocaleDateString();
        const client = x.client;
        ws_data.push(["ZEPHYR EXPRESS", "", "", "", "ZEPHYR EXPRESS", "", ""]);
        ws_data.push(["RECEIVER COPY (CONSIGNEE)", "", "", "", "RECEIVER COPY (POD)", "", ""]);
        ws_data.push(["", "", "", "", "", "", ""]);
        ws_data.push(["AWB NO:", x.id, "", "", "AWB NO:", x.id, ""]);
        ws_data.push(["DATE:", date, "", "", "DATE:", date, ""]);
        ws_data.push(["DESTINATION:", x.dest, "", "", "DESTINATION:", x.dest, ""]);
        ws_data.push(["NETWORK:", x.net, "", "", "NETWORK:", x.net, ""]);
        ws_data.push(["CLIENT:", client, "", "", "CLIENT:", client, ""]);
        ws_data.push(["PIECES:", x.boxes, "", "", "PIECES:", x.boxes, ""]);
        ws_data.push(["WEIGHT:", x.wgt + " KG", "", "", "WEIGHT:", x.wgt + " KG", ""]);
        ws_data.push(["CONTENTS:", x.type, "", "", "CONTENTS:", x.type, ""]);
        ws_data.push(["", "", "", "", "", "", ""]);
        ws_data.push(["Authorized Signatory", "", "", "", "Authorized Signatory", "", ""]);
        ws_data.push(["Zephyr Express", "", "", "", "Zephyr Express", "", ""]);
        ws_data.push(["", "", "", "", "", "", ""]);
        ws_data.push(["-------------------", "-------------------", "-------------------", "", "-------------------", "-------------------", "-------------------"]);
        ws_data.push(["", "", "", "", "", "", ""]);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const w = {wch:20};
    ws['!cols'] = [w, w, w, {wch:5}, w, w, w];
    XLSX.utils.book_append_sheet(wb, ws, "Receivers");
    XLSX.writeFile(wb, "Receivers_Copies.xlsx");
}

window.chkStype = function(el) {
    if(el.checked) {
        document.querySelectorAll('input[name="stype"]').forEach(c => { if(c!==el) c.checked=false; });
    } else {
        if(!document.querySelector('input[name="stype"]:checked')) document.getElementById('st_reg').checked=true;
    }
    const val = document.querySelector('input[name="stype"]:checked').value;
    const awb = document.getElementById('f_awb');
    let curr = awb.value.replace("-FRT", "");
    if(val === "CBV 5" || val === "Commercial") {
        if(curr && !curr.endsWith("-FRT")) awb.value = curr + "-FRT";
    } else {
        awb.value = curr;
    }
}

window.toggleAutoAwb = async function(el) {
    if(curRole !== 'Admin' && curRole !== 'Owner') return;
    const enabled = el.checked;
    await callApi({action:"setConfig", key:"AUTO_AWB", value: enabled.toString()});
    document.getElementById('autoAwbLabel').textContent = enabled ? "Enabled" : "Disabled";
    toast("Config Saved");
}

window.openHoldAction = function(id) {
    window.selectedHoldAwb = id;
    const item = window.APP_DATA.holdings.find(x => x.id === id);
    if(!item) return;

    document.getElementById('ham_awb').textContent = id;
    const netNo = item.netNo || '-';
    document.getElementById('ham_net').textContent = netNo;

    const net = (item.net || '').toUpperCase();
    const dest = (item.dest || '').toUpperCase();
    const isNA = net.startsWith('NA') || dest.startsWith('NA');

    if(isNA) {
        document.getElementById('ham_na_section').style.display = 'block';
        document.getElementById('ham_norm_section').style.display = 'none';

        // Fill Dropdowns only if needed
        if(window.APP_DATA.static && window.APP_DATA.static.dropdowns) {
            const dd = window.APP_DATA.static.dropdowns;
            let nOpts = '<option value="">Select Network...</option>';
            dd.networks.forEach(x => {
                 const val = x==="NA" ? "NA - Not Known" : x;
                 nOpts += `<option value="${val}">${val}</option>`;
            });
            document.getElementById('ham_sel_net').innerHTML = nOpts;

            let dOpts = '<option value="">Select Destination...</option>';
            dd.destinations.forEach(x => {
                 const val = x==="NA" ? "NA - Not Known" : x;
                 dOpts += `<option value="${val}">${val}</option>`;
            });
            document.getElementById('ham_sel_dest').innerHTML = dOpts;
        }
    } else {
        document.getElementById('ham_na_section').style.display = 'none';
        document.getElementById('ham_norm_section').style.display = 'block';
    }

    new bootstrap.Modal(document.getElementById('holdActionModal')).show();
}

window.hamClear = async function() {
    await callApi({action:"manageHold", subAction: "clear", awb: window.selectedHoldAwb, remarks: "Cleared via Manager"});
    bootstrap.Modal.getInstance(document.getElementById('holdActionModal')).hide();
    syncData(false);
    toast("Hold Cleared");
}

window.hamSubmit = async function() {
    const net = document.getElementById('ham_sel_net').value;
    const dest = document.getElementById('ham_sel_dest').value;
    if(!net && !dest) return alert("Select Network or Destination to update");

    // Update Details
    await callApi({action:"updateShipmentDetails", awb: window.selectedHoldAwb, network: net, destination: dest});
    // Clear Hold
    await callApi({action:"manageHold", subAction: "clear", awb: window.selectedHoldAwb, remarks: "Cleared via Quick Action"});

    bootstrap.Modal.getInstance(document.getElementById('holdActionModal')).hide();
    syncData(false);
    toast("Updated & Released");
}
window.hamRTO = function() {
    actRTO(window.selectedHoldAwb);
    bootstrap.Modal.getInstance(document.getElementById('holdActionModal')).hide();
}

// Rename option NA -> NA - Not Known globally during rendering dropdowns
const _origFillSel = window.fillSel;
window.fillSel = function(id, arr) {
    if(arr) {
        arr = arr.map(x => x === "NA" ? "NA - Not Known" : x);
    }
    const e = document.getElementById(id);
    if(!e || e.options.length > 1) return;
    if(arr) { let html=''; arr.forEach(x=>html+=`<option value="${x}">${x}</option>`); e.innerHTML+=html; }
}

window.viewRc = async function(id) {
    showSpin(true);
    const r = await fetchGet('getShipmentDetails&awb=' + encodeURIComponent(id));
    showSpin(false);
    if(r.result !== "success") return alert("Details not found");
    const d = r.shipment;
    const b = r.boxes || [];

    document.getElementById('vRc_title').textContent = `Shipment Details - ${id}`;
    const c = document.getElementById('vRc_content');

    // Summary
    const boxRows = b.map(x => `<tr><td>${x.no}</td><td>${x.l}x${x.b}x${x.h}</td><td>${x.vol}</td><td>${x.wgt}</td><td>${x.chg}</td></tr>`).join('');

    c.innerHTML = `
        <div class="d-flex justify-content-between mb-3 align-items-center">
             <div class="badge bg-primary text-white fs-6">Status: ${d.holdStatus === 'On Hold' ? 'On Hold' : 'Active'}</div>
             <button class="btn btn-dark" onclick="openPrintReceipt('${d.id}')"><i class="bi bi-printer-fill me-2"></i>Print Receiver Copy</button>
        </div>
        <div class="row g-3 mb-4 border-bottom pb-3">
            <div class="col-6"><small class="text-muted">User (Receiver)</small><div class="fw-bold">${d.user}</div></div>
            <div class="col-6"><small class="text-muted">Date</small><div>${new Date(d.date).toLocaleDateString()}</div></div>
            <div class="col-6"><small class="text-muted">Client</small><div>${d.client}</div></div>
            <div class="col-6"><small class="text-muted">Network</small><div>${d.net} (${d.netNo||'-'})</div></div>
            <div class="col-6"><small class="text-muted">Destination</small><div>${d.dest}</div></div>
            <div class="col-6"><small class="text-muted">Total Weight</small><div>${d.chgWgt} Kg</div></div>
        </div>
        <h6 class="fw-bold">Package Details</h6>
        <div class="table-responsive border rounded bg-light mb-3" style="max-height:200px">
           <table class="table table-sm table-striped mb-0 small text-center">
              <thead><tr><th>#</th><th>Dim (LxBxH)</th><th>Vol</th><th>Act</th><th>Chg</th></tr></thead>
              <tbody>${boxRows.length ? boxRows : '<tr><td colspan="5">No Detailed Box Data</td></tr>'}</tbody>
           </table>
        </div>
        <div class="d-grid"><button class="btn btn-success" onclick="exportReceiverExcel('${id}')"><i class="bi bi-file-earmark-excel me-2"></i>Export Excel Copy</button></div>
    `;

    // Cache data for print
    window.lastPrintData = { shipment: d, boxes: b };
    new bootstrap.Modal(document.getElementById('viewRcModal')).show();
}

window.openPrintReceipt = function(id) {
    const data = window.lastPrintData;
    if(!data || data.shipment.id !== id) return alert("Error: Data mismatch. Please close and re-open.");
    const s = data.shipment;

    const boxTable = data.boxes.map(x => `
       <tr>
          <td style="padding:4px;">${x.no}</td>
          <td style="padding:4px;">${x.l} x ${x.b} x ${x.h}</td>
          <td style="padding:4px;">${x.vol}</td>
          <td style="padding:4px;">${x.wgt}</td>
          <td style="padding:4px;">${x.chg}</td>
       </tr>
    `).join('');

    const renderCopy = (title) => `
        <div class="receipt-copy">
         <div class="header">
            <div class="header-content">
                <div><strong>ZEPHYR EXPRESS</strong></div>
                <div style="font-size:0.8rem">CB-385B, Ring Road Nariana, New Delhi-110028</div>
                <div style="font-size:0.8rem">Ph: 9873127666 | www.zephyrexpress.in</div>
                <div class="title">${title}</div>
            </div>
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/zephyrexpress/Booking/main/logo.png" class="logo">
                <svg class="barcode"></svg>
            </div>
         </div>

         <div class="grid">
            <div class="box">
               <div class="label">AWB Number</div><div class="val">${s.id}</div>
               <div class="label">Date</div><div class="val">${new Date(s.date).toLocaleDateString()}</div>
               <div class="label">Origin</div><div class="val">DEL (Delhi)</div>
               <div class="label">Destination</div><div class="val">${s.dest}</div>
            </div>
            <div class="box">
               <div class="label">Receiver Name</div><div class="val">${s.user}</div>
               <div class="label">Network</div><div class="val">${s.net}</div>
               <div class="label">Client</div><div class="val">${s.client}</div>
               <div class="label">Content</div><div class="val">${s.type}</div>
            </div>
         </div>
         <table>
            <thead><tr><th>Box #</th><th>Dim (L x B x H)</th><th>Vol Wgt</th><th>Act Wgt</th><th>Chg Wgt</th></tr></thead>
            <tbody>${boxTable || '<tr><td colspan="5" style="text-align:center;">Summary: '+s.boxes+' Pcs, '+s.chgWgt+' Kg</td></tr>'}</tbody>
            <tfoot><tr><td colspan="3" style="text-align:right; font-weight:bold;">TOTAL:</td><td style="border:1px solid #000; font-weight:bold;">${s.actWgt}</td><td style="border:1px solid #000; font-weight:bold;">${s.chgWgt}</td></tr></tfoot>
         </table>
         <div class="footer">
            <strong>TERMS & CONDITIONS (DISCLAIMER):</strong> By accepting this shipment, the sender/receiver agrees to the standard terms and conditions of carriage. Zephyr Express assumes no liability for delay, loss, or damage caused by circumstances beyond control. Claims must be notified within 24 hours of receipt. Restricted items are prohibited. Please visit www.zephyrexpress.in for full terms.
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
               <div>__________________<br>Sender</div>
               <div>__________________<br>Receiver</div>
            </div>
         </div>
        </div>
    `;

    const win = window.open('', '_blank', 'width=900,height=800');
    win.document.write(`
      <html>
      <head>
        <title>Receiver Copy - ${s.id}</title>
        <style>
           body { font-family: 'Courier New', Courier, monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
           .receipt-copy { height: 48vh; border-bottom: 2px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; position: relative; }
           .receipt-copy:last-child { border-bottom: none; }

           .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
           .header-content { flex: 1; text-align: left; }
           .logo-container { text-align: right; }
           .logo { max-height: 35px; display: block; margin-left: auto; margin-bottom: 5px; }
           .title { font-weight: bold; font-size: 1rem; text-decoration: underline; margin-top: 5px; }

           .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
           .box { border: 1px solid #000; padding: 5px; }
           .label { font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
           .val { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }

           table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.8rem; }
           th { background: #eee; border: 1px solid #000; padding: 3px; text-transform: uppercase; font-size: 0.7rem; }
           td { padding: 3px; border: 1px solid #000; }

           .footer { margin-top: 10px; font-size: 0.6rem; text-align: justify; border-top: 1px solid #000; padding-top: 5px; }
           @media print { .no-print { display: none; } body { padding: 0; } }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
      </head>
      <body>
         ${renderCopy('CLIENT COPY')}
         ${renderCopy('OFFICE RECORD')}

         <div class="no-print" style="text-align:center; margin-top:20px;">
            <button onclick="window.print()" style="padding:10px 20px; font-weight:bold; cursor:pointer;">PRINT COPY</button>
            <button onclick="window.close()" style="padding:10px 20px; cursor:pointer; margin-left:10px;">CLOSE</button>
         </div>

         <script>
            // Generate Barcode
            try {
               JsBarcode(".barcode", "${s.id}", { format: "CODE128", lineColor: "#000", width: 1.5, height: 30, displayValue: true, fontSize: 10 });
            } catch(e) { console.error(e); }
         <\/script>
      </body>
      </html>
    `);
    win.document.close();
}
</script>
</body>
</html>
