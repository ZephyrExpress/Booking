<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js" defer></script>

    <style>
      body { padding: 2rem; font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
      .card { max-width: 800px; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      #console { background: #1e1e1e; color: #00ff00; font-family: monospace; padding: 1rem; height: 200px; overflow-y: auto; border-radius: 4px; margin-top: 1rem; font-size: 0.9rem; }
      .fun-input { border: 2px solid #e2e8f0; transition: all 0.2s; }
      .fun-input:focus { border-color: #003399; box-shadow: 0 0 0 4px rgba(0, 51, 153, 0.1); }
      .fun-label { color: #475569; font-weight: 600; font-size: 0.85rem; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.5px; }
    </style>
  </head>
  <body>
    <div class="card mb-4">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">TiDB Speed Test (Inbound)</h5>
        <button class="btn btn-sm btn-outline-light" onclick="window.location.search=''">Back to Login</button>
      </div>
      <div class="card-body">

        <ul class="nav nav-pills mb-4" id="pills-tab">
          <li class="nav-item">
            <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button">Benchmark</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button">Inbound Entry</button>
          </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
          <!-- BENCHMARK TAB -->
          <div class="tab-pane fade show active" id="pills-home">
             <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="testConnection()">
                <i class="bi bi-plug"></i> Test Connection
              </button>
              <button class="btn btn-outline-dark" onclick="runSpeedTest()">
                <i class="bi bi-speedometer2"></i> Run Speed Benchmark
              </button>
            </div>
            <div id="console">Ready...</div>
          </div>

          <!-- INBOUND ENTRY TAB -->
          <div class="tab-pane fade" id="pills-profile">
             <div class="alert alert-info small"><i class="bi bi-info-circle me-2"></i>This form submits directly to TiDB via GAS Backend.</div>
             <form id="tidbForm" onsubmit="event.preventDefault(); submitToTidb();">
               <div class="row g-3 mb-3">
                 <div class="col-md-6">
                    <label class="fun-label">AWB *</label>
                    <input id="f_awb" class="form-control fun-input" required placeholder="000-00000000">
                 </div>
                 <div class="col-md-6">
                    <label class="fun-label">Date *</label>
                    <input type="date" id="f_date" class="form-control fun-input" required>
                 </div>
                 <div class="col-md-6">
                    <label class="fun-label">Client *</label>
                    <input id="f_client" class="form-control fun-input" required placeholder="Client Name">
                 </div>
                 <div class="col-md-6">
                    <label class="fun-label">Network *</label>
                    <select id="f_net" class="form-select fun-input" required>
                        <option value="" disabled selected>Select...</option>
                        <option>DHL</option><option>FedEx</option><option>UPS</option><option>Aramex</option>
                    </select>
                 </div>
                 <div class="col-md-6">
                    <label class="fun-label">Destination *</label>
                    <input id="f_dest" class="form-control fun-input" required placeholder="Country/City">
                 </div>
                 <div class="col-md-6">
                    <label class="fun-label">Total Boxes *</label>
                    <input type="number" id="f_boxes" class="form-control fun-input" required>
                 </div>
                 <div class="col-md-6">
                    <label class="fun-label">Total Weight *</label>
                    <input type="number" step="0.01" id="f_wgt" class="form-control fun-input" required>
                 </div>
               </div>
               <button class="btn btn-success w-100 fw-bold py-2">Submit to TiDB</button>
             </form>
             <div id="formResult" class="mt-3"></div>
          </div>
        </div>

      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
          document.getElementById('f_date').valueAsDate = new Date();
      });

      function log(msg, type='info') {
        const c = document.getElementById('console');
        const ts = new Date().toLocaleTimeString();
        const color = type === 'error' ? '#ff6b6b' : (type === 'success' ? '#51cf66' : '#00ff00');
        c.innerHTML += `<div style="color:${color}">[${ts}] ${msg}</div>`;
        c.scrollTop = c.scrollHeight;
      }

      function testConnection() {
        log("Connecting to TiDB...", "info");
        google.script.run
          .withSuccessHandler(res => log(res.message, res.success ? "success" : "error"))
          .withFailureHandler(err => log("RPC Error: " + err.message, "error"))
          .testTidbConnection();
      }

      function runSpeedTest() {
        log("Running Benchmark...", "info");
        google.script.run
          .withSuccessHandler(res => {
             if(res.success) {
                 log("BENCHMARK COMPLETE", "success");
                 log(`Total: ${res.data.totalTime}ms | Connect: ${res.data.connectTime}ms | Insert: ${res.data.insertTime}ms`);
             } else log("Fail: " + res.message, "error");
          })
          .withFailureHandler(err => log("RPC Error: " + err.message, "error"))
          .runTidbSpeedTest();
      }

      function submitToTidb() {
          const btn = document.querySelector('#tidbForm button');
          const res = document.getElementById('formResult');
          btn.disabled = true;
          btn.textContent = "Saving...";
          res.innerHTML = "";

          const data = {
              awb: document.getElementById('f_awb').value,
              date: document.getElementById('f_date').value,
              client: document.getElementById('f_client').value,
              net: document.getElementById('f_net').value,
              dest: document.getElementById('f_dest').value,
              boxes: document.getElementById('f_boxes').value,
              wgt: document.getElementById('f_wgt').value
          };

          const start = new Date().getTime();

          google.script.run
            .withSuccessHandler(r => {
                btn.disabled = false; btn.textContent = "Submit to TiDB";
                const time = new Date().getTime() - start;
                if(r.success) {
                    res.innerHTML = `<div class="alert alert-success">Saved in ${time}ms! ID: ${data.awb}</div>`;
                    document.getElementById('tidbForm').reset();
                    document.getElementById('f_date').valueAsDate = new Date();
                } else {
                    res.innerHTML = `<div class="alert alert-danger">Error: ${r.message}</div>`;
                }
            })
            .withFailureHandler(e => {
                btn.disabled = false; btn.textContent = "Submit to TiDB";
                res.innerHTML = `<div class="alert alert-danger">RPC Error: ${e.message}</div>`;
            })
            .submitToTidb(data);
      }
    </script>
  </body>
</html>
